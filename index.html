<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çµ±ä¸€æ±½è»Š - ç·šä¸Šé ç´„</title>
    <script src="https://kit.fontawesome.com/ca83b2e10a.js" crossorigin="anonymous"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <!-- SweetAlert2 CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sweetalert2/11.10.1/sweetalert2.all.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/sweetalert2/11.10.1/sweetalert2.min.css">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <!-- æ¨™é¡Œå€åŸŸ -->
        <header class="header">
            <h1>è‹—æ —çµ±ä¸€æ±½è»Š</h1>
            <p>ç·šä¸Šé ç´„ç³»çµ±</p>
            <div class="shop-info">
                <p id="userGreeting">é€£æ¥ä¸­...</p>
            </div>
        </header>

        <!-- é™¤éŒ¯è³‡è¨Š -->
        <div class="debug-info" style="display:none">
            <h3>ğŸ” é™¤éŒ¯æª¢æŸ¥</h3>
            <div>LIFF ç‹€æ…‹: <span id="liffStatus">æª¢æŸ¥ä¸­...</span></div>
            <div>ç”¨æˆ¶ID: <span id="userIdDebug">æœªå–å¾—</span></div>
            <div>API URL: <span id="apiUrlDebug">æœªè¨­å®š</span></div>
            <div>æœ€å¾ŒéŒ¯èª¤: <span id="lastError">ç„¡</span></div>
        </div>

        <!-- é ç´„è¡¨å–® -->
        <form id="bookingForm" class="booking-form">
            <div class="form-group">
                <label for="name">å§“å *</label>
                <input type="text" id="name" name="name" required>
            </div>

            <div class="form-group">
                <label for="phone">é›»è©± *</label>
                <input type="tel" id="phone" name="phone" required placeholder="è«‹è¼¸å…¥æ‚¨çš„è¯çµ¡é›»è©±">
            </div>

            <div class="form-group">
                <label for="plate">è»Šç‰Œ *</label>
                <input type="text" id="plate" name="plate" required placeholder="ä¾‹ï¼šABC-1234">
            </div>

            <div class="form-group">
                <label>é ç´„æ—¥æœŸ *</label>
                <div class="date-buttons" id="dateButtons"></div>
                <input type="hidden" id="dateInput" name="date" required>
                <small class="hint">å¯é ç´„æœªä¾†14å¤©å…§ï¼Œé€±æ—¥ä¸é–‹æ”¾</small>
            </div>

            <div class="form-group">
                <label for="time">é ç´„æ™‚æ®µ *</label>
                <select id="time" name="time" required>
                    <option value="">è«‹å…ˆé¸æ“‡æ—¥æœŸ</option>
                </select>
                <small class="hint">é€±å…­åƒ…é–‹æ”¾ä¸Šåˆæ™‚æ®µ</small>
            </div>

            <div class="form-group">
                <label for="serviceType">æœå‹™é …ç›® *</label>
                <select id="serviceType" name="serviceType" required>
                    <option value="">è«‹é¸æ“‡æœå‹™é …ç›®</option>
                    <option value="ä¿é¤Š">ä¿é¤Š</option>
                    <option value="ç¶­ä¿®">ç¶­ä¿®</option>
                    <option value="å…¶ä»–">å…¶ä»–</option>
                </select>
            </div>

            <div class="form-group">
                <label for="note">å‚™è¨»ï¼ˆæ–°å®¢æˆ¶è«‹æä¾›è»Šè¼›å» ç‰Œèˆ‡è»Šå‹ï¼‰</label>
                <textarea id="note" name="note" placeholder=""></textarea>
                <small class="hint" style="color:red">åˆæ¬¡ä¾†è¨ªè»Šè¼›ï¼Œè«‹æ”œå¸¶è»Šå­çš„ç¶ è‰²è¡Œç…§ä»¥ä¾¿è³‡æ–™ç™»å…¥</small>
            </div>

            <button type="submit" class="submit-btn">ç¢ºèªé ç´„</button>
        </form>

        <!-- è¼‰å…¥ä¸­é®ç½© -->
        <div id="loading" class="loading-overlay">
            <div class="loading-spinner"></div>
            <p>é ç´„è™•ç†ä¸­...</p>
        </div>
    </div>

    <script>
        // âš ï¸ è«‹ç¢ºèªé€™å€‹ URL æ˜¯å¦æ­£ç¢ºä¸”å·²éƒ¨ç½²
        const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzAhNvgzW5ZqPteINKHd69LpE3rK2L28htSfENqKncvgOh3UKh5DOEkaUEpp8Pj86BF/exec';

        // LIFF ç›¸é—œè®Šæ•¸
        let liffProfile = null;
        let liffUserId = null;
        let selectedDate = null;

        // æ™‚æ®µé¸é …
        const timeSlots = {
            morning: ['8:00', '8:30', '9:00', '9:30', '10:00', '10:30', '11:00'],
            afternoon: ['13:30', '14:00', '14:30', '15:00', '15:30', '16:00', '16:30']
        };

        // æ˜ŸæœŸå°æ‡‰
        const weekDays = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];

        // æ›´æ–°é™¤éŒ¯è³‡è¨Š
        function updateDebugInfo(key, value) {
            const element = document.getElementById(key);
            if (element) {
                element.textContent = value;
            }
        }

        // è¨˜éŒ„éŒ¯èª¤
        function logError(error) {
            console.error('éŒ¯èª¤:', error);
            updateDebugInfo('lastError', error.message || error);
        }

        // åˆå§‹åŒ– LIFF
        async function initializeLiff() {
            try {
                updateDebugInfo('liffStatus', 'åˆå§‹åŒ–ä¸­...');
                
                // å…ˆæª¢æŸ¥æ˜¯å¦åœ¨ LINE ç’°å¢ƒä¸­
                if (typeof liff === 'undefined') {
                    throw new Error('LIFF SDK æœªè¼‰å…¥');
                }

                await liff.init({
                    liffId: '2007724265-YJ80zrNX'  // â† ç¢ºèªé€™å€‹ LIFF ID æ˜¯å¦æ­£ç¢º
                });

                updateDebugInfo('liffStatus', 'å·²é€£æ¥');

                if (liff.isLoggedIn()) {
                    const profile = await liff.getProfile();
                    liffProfile = profile;
                    liffUserId = profile.userId;
                    
                    updateDebugInfo('userIdDebug', liffUserId);
                    document.getElementById('userGreeting').textContent = `æ‚¨å¥½ï¼Œ${profile.displayName}`;
                    document.getElementById('name').value = profile.displayName;
                    
                    updateDebugInfo('liffStatus', 'å·²ç™»å…¥');
                } else {
                    updateDebugInfo('liffStatus', 'æœªç™»å…¥ï¼Œå˜—è©¦ç™»å…¥...');
                    liff.login();
                }

            } catch (error) {
                logError(error);
                updateDebugInfo('liffStatus', 'å¤±æ•—: ' + error.message);
                document.getElementById('userGreeting').textContent = 'è«‹ä½¿ç”¨ LINE é–‹å•Ÿæ­¤é ç´„é é¢';
                
                // å¦‚æœ LIFF å¤±æ•—ï¼Œä½¿ç”¨æ¸¬è©¦ç”¨æˆ¶
                liffUserId = 'test-user-' + Date.now();
                updateDebugInfo('userIdDebug', liffUserId + ' (æ¸¬è©¦æ¨¡å¼)');
            }
        }

        // å‰µå»ºæ—¥æœŸæŒ‰éˆ•
        function createDateButtons() {
            const dateButtonsContainer = document.getElementById('dateButtons');
            const today = new Date();
            
            dateButtonsContainer.innerHTML = '';
            
            for (let i = 0; i < 14; i++) {
                const date = new Date(today);
                date.setDate(today.getDate() + i);
                
                const dayOfWeek = date.getDay();
                const isSunday = dayOfWeek === 0;
                
                const button = document.createElement('div');
                button.className = 'date-button';
                
                if (isSunday) {
                    button.classList.add('disabled');
                }
                
                const month = date.getMonth() + 1;
                const day = date.getDate();
                const weekDay = weekDays[dayOfWeek];
                
                button.innerHTML = `
                    <div class="date-main">${month}/${day}</div>
                    <div class="date-day">(${weekDay})</div>
                `;
                
                button.setAttribute('data-date', date.toISOString().split('T')[0]);
                
                if (!isSunday) {
                    button.addEventListener('click', () => selectDate(button));
                }
                
                dateButtonsContainer.appendChild(button);
            }
        }

        // é¸æ“‡æ—¥æœŸ
        function selectDate(buttonElement) {
            const dateValue = buttonElement.getAttribute('data-date');
            
            document.querySelectorAll('.date-button').forEach(btn => {
                btn.classList.remove('selected');
            });
            
            buttonElement.classList.add('selected');
            document.getElementById('dateInput').value = dateValue;
            selectedDate = dateValue;
            
            updateTimeSlots();
        }

        // æ›´æ–°æ™‚æ®µé¸é … (ä¿®æ”¹ç‰ˆ - åŠ å…¥ç•¶æ—¥æ™‚é–“éæ¿¾)
        function updateTimeSlots() {
            const timeSelect = document.getElementById('time');
            
            if (!selectedDate) {
                timeSelect.innerHTML = '<option value="">è«‹å…ˆé¸æ“‡æ—¥æœŸ</option>';
                return;
            }

            const selectedDateObj = new Date(selectedDate);
            const today = new Date();
            const isToday = selectedDateObj.toDateString() === today.toDateString();
            const currentTime = today.getHours() * 60 + today.getMinutes(); // è½‰æ›ç‚ºåˆ†é˜æ•¸ä¾¿æ–¼æ¯”è¼ƒ
            
            const dayOfWeek = selectedDateObj.getDay();

            timeSelect.innerHTML = '<option value="">è«‹é¸æ“‡æ™‚æ®µ</option>';

            // åŠ å…¥ä¸Šåˆæ™‚æ®µ
            timeSlots.morning.forEach(time => {
                const [hours, minutes] = time.split(':').map(Number);
                const timeInMinutes = hours * 60 + minutes;
                
                // å¦‚æœæ˜¯ä»Šå¤©ï¼Œæª¢æŸ¥æ™‚é–“æ˜¯å¦å·²é
                // åŠ å…¥30åˆ†é˜çš„ç·©è¡æ™‚é–“ï¼Œç¢ºä¿å®¢æˆ¶æœ‰è¶³å¤ æ™‚é–“æº–å‚™
                const shouldShow = !isToday || (timeInMinutes > currentTime + 30);
                
                if (shouldShow) {
                    const option = document.createElement('option');
                    option.value = time;
                    option.textContent = time;
                    timeSelect.appendChild(option);
                }
            });

            // åŠ å…¥ä¸‹åˆæ™‚æ®µï¼ˆé€±ä¸€åˆ°é€±äº”ï¼‰
            if (dayOfWeek >= 1 && dayOfWeek <= 5) {
                timeSlots.afternoon.forEach(time => {
                    const [hours, minutes] = time.split(':').map(Number);
                    const timeInMinutes = hours * 60 + minutes;
                    
                    // å¦‚æœæ˜¯ä»Šå¤©ï¼Œæª¢æŸ¥æ™‚é–“æ˜¯å¦å·²é
                    const shouldShow = !isToday || (timeInMinutes > currentTime + 30);
                    
                    if (shouldShow) {
                        const option = document.createElement('option');
                        option.value = time;
                        option.textContent = time;
                        timeSelect.appendChild(option);
                    }
                });
            }
            
            // å¦‚æœç•¶æ—¥æ²’æœ‰å¯é¸æ“‡çš„æ™‚æ®µï¼Œé¡¯ç¤ºæç¤º
            if (isToday && timeSelect.options.length === 1) {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = 'ä»Šæ—¥å·²ç„¡å¯é ç´„æ™‚æ®µ';
                option.disabled = true;
                timeSelect.appendChild(option);
            }
        }

        // ç”Ÿæˆé ç´„ç·¨è™Ÿ
        function generateBookingId() {
            const today = new Date();
            const dateStr = today.toISOString().slice(0, 10).replace(/-/g, '');
            const randomStr = Math.random().toString(36).substr(2, 5).toUpperCase();
            return `A${dateStr}-${randomStr}`;
        }

        // è¡¨å–®é©—è­‰
        function validateForm() {
            const form = document.getElementById('bookingForm');
            const formData = new FormData(form);
            let isValid = true;

            document.querySelectorAll('.error').forEach(el => el.classList.remove('error'));
            document.querySelectorAll('.error-message').forEach(el => el.remove());

            const requiredFields = ['name', 'phone', 'plate', 'date', 'time', 'serviceType'];
            
            requiredFields.forEach(fieldName => {
                const field = document.getElementById(fieldName);
                let value;
                
                if (fieldName === 'date') {
                    value = document.getElementById('dateInput').value;
                } else {
                    value = formData.get(fieldName);
                }
                
                if (!value || value.trim() === '') {
                    if (fieldName === 'date') {
                        const dateButtonsContainer = document.getElementById('dateButtons');
                        dateButtonsContainer.style.border = '2px solid #e74c3c';
                        showFieldError(dateButtonsContainer, 'è«‹é¸æ“‡é ç´„æ—¥æœŸ');
                    } else {
                        field.classList.add('error');
                        showFieldError(field, 'æ­¤æ¬„ä½ç‚ºå¿…å¡«');
                    }
                    isValid = false;
                }
            });

            const phone = formData.get('phone');
            if (phone && !/^[0-9-+\s()]{8,15}$/.test(phone)) {
                const phoneField = document.getElementById('phone');
                phoneField.classList.add('error');
                showFieldError(phoneField, 'è«‹è¼¸å…¥æœ‰æ•ˆçš„é›»è©±è™Ÿç¢¼');
                isValid = false;
            }

            return isValid;
        }

        // é¡¯ç¤ºæ¬„ä½éŒ¯èª¤è¨Šæ¯
        function showFieldError(field, message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.textContent = message;
            field.parentNode.insertBefore(errorDiv, field.nextSibling);
        }

        // é€£æ¥åˆ° Google Apps Script (ä¿®æ­£ç‰ˆ)
        async function callGAS(action, data) {
            try {
                updateDebugInfo('apiUrlDebug', GAS_WEB_APP_URL);
                
                const payload = {
                    action: action,
                    ...data
                };

                console.log('ç™¼é€åˆ° GAS:', payload);

                // ä¿®æ­£ï¼šä½¿ç”¨ POST æ–¹å¼ä¸¦æ­£ç¢ºè¨­å®š Content-Type
                const response = await fetch(GAS_WEB_APP_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'text/plain',  // æ”¹ç‚º text/plain
                    },
                    body: JSON.stringify(payload),
                    mode: 'cors'
                });

                console.log('HTTP ç‹€æ…‹:', response.status);
                console.log('Response Headers:', [...response.headers.entries()]);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('HTTP éŒ¯èª¤å›æ‡‰:', errorText);
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }

                const result = await response.json();
                console.log('GAS å›æ‡‰:', result);
                return result;

            } catch (error) {
                console.error('GAS API èª¿ç”¨å¤±æ•—:', error);
                logError(error);
                throw error;
            }
        }

        // ä½¿ç”¨ SweetAlert2 é¡¯ç¤ºæˆåŠŸè¨Šæ¯
        function showSuccessMessage(bookingId) {
            Swal.fire({
                icon: 'success',
                title: 'é ç´„æˆåŠŸï¼',
                html: `
                    <div style="font-size: 1.1rem; color: #2c3e50; margin: 20px 0;">
                        <p style="margin-bottom: 10px;">æ‚¨çš„é ç´„ç·¨è™Ÿï¼š</p>
                        <p style="font-weight: bold; color: #e74c3c; font-size: 1.3rem;">${bookingId}</p>
                    </div>
                `,
                confirmButtonText: 'é—œé–‰',
                confirmButtonColor: '#3498db',
                backdrop: 'rgba(0,0,0,0.6)',
                customClass: {
                    popup: 'swal-popup-custom',
                    title: 'swal-title-custom'
                },
                allowOutsideClick: false,
                allowEscapeKey: false,
                width: '90%',
                maxWidth: '400px'
            }).then((result) => {
                if (result.isConfirmed) {
                    closeSuccessMessage();
                }
            });
        }

        // ä½¿ç”¨ SweetAlert2 é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
        function showErrorMessage(message) {
            Swal.fire({
                icon: 'error',
                title: 'é ç´„å¤±æ•—',
                text: message,
                confirmButtonText: 'ç¢ºå®š',
                confirmButtonColor: '#e74c3c',
                backdrop: 'rgba(0,0,0,0.6)',
                width: '90%',
                maxWidth: '400px'
            });
        }

        // æäº¤è¡¨å–®
        async function submitForm(event) {
            event.preventDefault();
            
            if (!validateForm()) {
                return;
            }

            const loading = document.getElementById('loading');
            const submitBtn = document.querySelector('.submit-btn');
            
            loading.style.display = 'flex';
            submitBtn.disabled = true;
            submitBtn.textContent = 'è™•ç†ä¸­...';

            try {
                const formData = new FormData(document.getElementById('bookingForm'));
                const bookingId = generateBookingId();
                
                const bookingData = {
                    userId: liffUserId || 'fallback-user',
                    bookingId: bookingId,
                    name: formData.get('name'),
                    phone: formData.get('phone'),
                    plate: formData.get('plate'),
                    date: document.getElementById('dateInput').value,
                    time: formData.get('time'),
                    serviceType: formData.get('serviceType'),
                    note: formData.get('note') || '',
                    timestamp: new Date().toISOString()
                };

                console.log('ç™¼é€é ç´„è³‡æ–™:', bookingData);

                const result = await callGAS('createBooking', bookingData);
                
                console.log('GAS å›æ‡‰:', result);

                if (result.success) {
                    showSuccessMessage(bookingId);
                } else {
                    throw new Error(result.message || 'é ç´„å¤±æ•—');
                }
                
            } catch (error) {
                console.error('é ç´„æäº¤å¤±æ•—:', error);
                logError(error);
                
                let errorMessage = 'é ç´„å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦';
                
                if (error.message.includes('HTTP')) {
                    errorMessage = 'ä¼ºæœå™¨é€£æ¥å•é¡Œï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·š';
                } else if (error.message.includes('Failed to fetch')) {
                    errorMessage = 'ç¶²è·¯é€£æ¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯è¨­å®š';
                } else if (error.message) {
                    errorMessage = error.message;
                }
                
                showErrorMessage(errorMessage);
                
            } finally {
                loading.style.display = 'none';
                submitBtn.disabled = false;
                submitBtn.textContent = 'ç¢ºèªé ç´„';
            }
        }

        // é—œé–‰æˆåŠŸè¨Šæ¯
        function closeSuccessMessage() {
            document.getElementById('bookingForm').reset();
            selectedDate = null;
            document.querySelectorAll('.date-button').forEach(btn => {
                btn.classList.remove('selected');
            });
            document.getElementById('dateInput').value = '';
            updateTimeSlots();
            
            if (liff && liff.isInClient()) {
                liff.closeWindow();
            }
        }

        // é é¢è¼‰å…¥å®Œæˆå¾Œåˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('é é¢è¼‰å…¥å®Œæˆï¼Œé–‹å§‹åˆå§‹åŒ–...');
            
            initializeLiff();
            createDateButtons();
            
            document.getElementById('bookingForm').addEventListener('submit', submitForm);
            
            console.log('åˆå§‹åŒ–å®Œæˆ');
        });
    </script>
</body>
</html>