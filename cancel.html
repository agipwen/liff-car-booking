<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çµ±ä¸€æ±½è»Š - é ç´„æŸ¥è©¢</title>
    <script src="https://kit.fontawesome.com/ca83b2e10a.js" crossorigin="anonymous"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <link rel="stylesheet" href="cancel.css">
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>çµ±ä¸€æ±½è»Š</h1>
            <p>é ç´„æŸ¥è©¢ç³»çµ±</p>
        </header>

        <div class="content">
            <!-- æ¨¡æ“¬æ¸¬è©¦æŒ‰éˆ• -->
            <div class="debug-info" style="background: #e7f3ff; border-color: #007bff;">
                <h3>ğŸš€ æ¨¡æ“¬æ¸¬è©¦</h3>
                <p>é€™æ˜¯æ¨¡æ“¬ç‰ˆæœ¬ï¼Œæ‚¨å¯ä»¥æ¸¬è©¦ä¸åŒçš„æƒ…æ³ï¼š</p>
                <div style="margin-top: 10px;">
                    <button onclick="testNormalBooking()" class="btn btn-primary" style="margin: 5px; padding: 8px 15px; font-size: 0.9em;">
                        æ¸¬è©¦æ­£å¸¸é ç´„
                    </button>
                    <button onclick="testCancelledBooking()" class="btn btn-secondary" style="margin: 5px; padding: 8px 15px; font-size: 0.9em;">
                        æ¸¬è©¦å·²å–æ¶ˆé ç´„
                    </button>
                    <button onclick="testInvalidBooking()" class="btn btn-danger" style="margin: 5px; padding: 8px 15px; font-size: 0.9em;">
                        æ¸¬è©¦ç„¡æ•ˆé ç´„
                    </button>
                </div>
            </div>

            <!-- é™¤éŒ¯è³‡è¨Š -->
            <div class="debug-info">
                <h3>ğŸ” é™¤éŒ¯æª¢æŸ¥</h3>
                <div>é ç´„ç·¨è™Ÿ: <span id="bookingIdParam">æœªå–å¾—</span></div>
                <div>ç”¨æˆ¶ID: <span id="userIdParam">æœªå–å¾—</span></div>
                <div>API URL: <span id="apiUrlDebug">æœªè¨­å®š</span></div>
                <div>LIFF ç‹€æ…‹: <span id="liffStatus">æª¢æŸ¥ä¸­...</span></div>
                <div>æœ€å¾ŒéŒ¯èª¤: <span id="lastError">ç„¡</span></div>
            </div>

            <!-- è¼‰å…¥ä¸­ -->
            <div id="loading" class="loading">
                <i class="fas fa-spinner"></i>
                <p>æŸ¥è©¢é ç´„è³‡æ–™ä¸­...</p>
            </div>

            <!-- éŒ¯èª¤è¨Šæ¯ -->
            <div id="errorMessage" class="error-message" style="display: none;">
                <i class="fas fa-exclamation-triangle"></i>
                <h3>æŸ¥è©¢å¤±æ•—</h3>
                <p id="errorText"></p>
            </div>

            <!-- æˆåŠŸå–æ¶ˆè¨Šæ¯ -->
            <div id="successMessage" class="success-message" style="display: none;">
                <i class="fas fa-check-circle"></i>
                <h3>é ç´„å·²å–æ¶ˆ</h3>
                <p>æ‚¨çš„é ç´„å·²æˆåŠŸå–æ¶ˆ</p>
            </div>

            <!-- é ç´„è©³æƒ… -->
            <div id="bookingDetails" class="booking-details" style="display: none;">
                <div class="booking-header">
                    <div class="booking-id">é ç´„ç·¨è™Ÿï¼š<span id="displayBookingId"></span></div>
                    <div class="booking-status" id="bookingStatus"></div>
                </div>

                <div class="detail-grid">
                    <div class="detail-item">
                        <div class="detail-label">é ç´„äººå§“å</div>
                        <div class="detail-value" id="customerName"></div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">è¯çµ¡é›»è©±</div>
                        <div class="detail-value" id="customerPhone"></div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">è»Šç‰Œè™Ÿç¢¼</div>
                        <div class="detail-value highlight" id="carPlate"></div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">é ç´„æ—¥æœŸ</div>
                        <div class="detail-value highlight" id="appointmentDate"></div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">é ç´„æ™‚é–“</div>
                        <div class="detail-value highlight" id="appointmentTime"></div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">æœå‹™é …ç›®</div>
                        <div class="detail-value" id="serviceType"></div>
                    </div>
                    <div class="detail-item" style="grid-column: 1 / -1;">
                        <div class="detail-label">å‚™è¨»</div>
                        <div class="detail-value" id="appointmentNote">ç„¡</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">é ç´„å»ºç«‹æ™‚é–“</div>
                        <div class="detail-value" id="createdTime"></div>
                    </div>
                </div>

                <div class="action-buttons">
                    <button id="cancelBtn" class="btn btn-danger">
                        <i class="fas fa-times"></i> å–æ¶ˆé ç´„
                    </button>
                    <button id="closeBtn" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> è¿”å›
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- å–æ¶ˆç¢ºèªå°è©±æ¡† -->
    <div id="cancelModal" class="modal">
        <div class="modal-content">
            <h3><i class="fas fa-exclamation-triangle"></i> ç¢ºèªå–æ¶ˆé ç´„</h3>
            <p>æ‚¨ç¢ºå®šè¦å–æ¶ˆé€™å€‹é ç´„å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚</p>
            <div class="modal-buttons">
                <button id="confirmCancelBtn" class="btn btn-danger">ç¢ºèªå–æ¶ˆ</button>
                <button id="cancelCancelBtn" class="btn btn-secondary">ä¿ç•™é ç´„</button>
            </div>
        </div>
    </div>

    <script>
        // è«‹ä½¿ç”¨èˆ‡é ç´„é é¢ç›¸åŒçš„ GAS URL
        const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzAhNvgzW5ZqPteINKHd69LpE3rK2L28htSfENqKncvgOh3UKh5DOEkaUEpp8Pj86BF/exec';

        // å…¨åŸŸè®Šæ•¸
        let bookingId = null;
        let userId = null;
        let bookingData = null;
        let liffProfile = null;

        // æ›´æ–°é™¤éŒ¯è³‡è¨Š
        function updateDebugInfo(key, value) {
            const element = document.getElementById(key);
            if (element) {
                element.textContent = value;
            }
        }

        // è¨˜éŒ„éŒ¯èª¤
        function logError(error) {
            console.error('éŒ¯èª¤:', error);
            updateDebugInfo('lastError', error.message || error);
        }

        // å¾ URL å–å¾—åƒæ•¸ (æ¨¡æ“¬ç‰ˆæœ¬)
        function getUrlParameters() {
            const urlParams = new URLSearchParams(window.location.search);
            bookingId = urlParams.get('bookingId');
            userId = urlParams.get('userId');

            // å¦‚æœæ²’æœ‰åƒæ•¸ï¼Œä½¿ç”¨æ¨¡æ“¬è³‡æ–™
            if (!bookingId) {
                bookingId = 'A20241211-TEST1';
                console.log('ä½¿ç”¨æ¨¡æ“¬é ç´„ç·¨è™Ÿ:', bookingId);
            }
            if (!userId) {
                userId = 'U123456789test';
                console.log('ä½¿ç”¨æ¨¡æ“¬ç”¨æˆ¶ID:', userId);
            }

            updateDebugInfo('bookingIdParam', bookingId + ' (æ¨¡æ“¬)');
            updateDebugInfo('userIdParam', userId + ' (æ¨¡æ“¬)');

            return true;
        }

        // åˆå§‹åŒ– LIFF
        async function initializeLiff() {
            try {
                updateDebugInfo('liffStatus', 'åˆå§‹åŒ–ä¸­...');

                if (typeof liff === 'undefined') {
                    updateDebugInfo('liffStatus', 'LIFF SDK æœªè¼‰å…¥');
                    return;
                }

                await liff.init({
                    liffId: '2007724265-YJ80zrNX'
                });

                updateDebugInfo('liffStatus', 'å·²é€£æ¥');

                if (liff.isLoggedIn()) {
                    const profile = await liff.getProfile();
                    liffProfile = profile;
                    updateDebugInfo('liffStatus', 'å·²ç™»å…¥');
                } else {
                    updateDebugInfo('liffStatus', 'æœªç™»å…¥');
                }

            } catch (error) {
                logError(error);
                updateDebugInfo('liffStatus', 'å¤±æ•—: ' + error.message);
            }
        }

        // èª¿ç”¨ Google Apps Script (æ¨¡æ“¬ç‰ˆæœ¬)
        async function callGAS(action, data) {
            try {
                updateDebugInfo('apiUrlDebug', GAS_WEB_APP_URL + ' (æ¨¡æ“¬æ¨¡å¼)');

                const payload = {
                    action: action,
                    ...data
                };

                console.log('ç™¼é€åˆ° GAS (æ¨¡æ“¬):', payload);

                // æ¨¡æ“¬ç¶²è·¯å»¶é²
                await new Promise(resolve => setTimeout(resolve, 1000));

                // æ¨¡æ“¬ä¸åŒçš„å›æ‡‰
                let result;
                if (action === 'getBooking') {
                    result = mockGetBooking(data);
                } else if (action === 'cancelBooking') {
                    result = mockCancelBooking(data);
                } else {
                    result = { success: false, message: 'æœªçŸ¥çš„æ“ä½œ' };
                }

                console.log('GAS å›æ‡‰ (æ¨¡æ“¬):', result);
                return result;

            } catch (error) {
                console.error('GAS API èª¿ç”¨å¤±æ•—:', error);
                logError(error);
                throw error;
            }
        }

        // æ¨¡æ“¬æŸ¥è©¢é ç´„è³‡æ–™
        function mockGetBooking(data) {
            const { bookingId, userId } = data;
            
            // æ¨¡æ“¬ä¸åŒçš„æƒ…æ³
            if (!bookingId || bookingId === 'invalid') {
                return {
                    success: false,
                    message: 'æ‰¾ä¸åˆ°é ç´„è³‡æ–™ï¼Œè«‹æª¢æŸ¥é ç´„ç·¨è™Ÿ'
                };
            }

            if (bookingId === 'cancelled') {
                return {
                    success: true,
                    data: {
                        bookingId: 'A20241211-XYZ99',
                        name: 'ç‹å°æ˜',
                        phone: '0912-345-678',
                        plate: 'ABC-1234',
                        date: '2024-12-15',
                        time: '10:00',
                        serviceType: 'ä¿é¤Š',
                        note: 'ç¬¬ä¸€æ¬¡ä¾†è¨ªï¼ŒToyota Camry 2020å¹´',
                        timestamp: '2024-12-11T10:30:00.000Z',
                        status: 'cancelled'
                    }
                };
            }

            // é è¨­è¿”å›æ­£å¸¸é ç´„è³‡æ–™
            return {
                success: true,
                data: {
                    bookingId: bookingId,
                    name: 'å¼µå¤§è¯',
                    phone: '0987-654-321',
                    plate: 'DEF-5678',
                    date: '2024-12-20',
                    time: '14:30',
                    serviceType: 'ç¶­ä¿®',
                    note: 'ç…è»Šç•°éŸ³éœ€è¦æª¢æŸ¥',
                    timestamp: '2024-12-11T09:15:00.000Z',
                    status: 'active'
                }
            };
        }

        // æ¨¡æ“¬å–æ¶ˆé ç´„
        function mockCancelBooking(data) {
            const { bookingId, userId } = data;
            
            // æ¨¡æ“¬å–æ¶ˆæˆåŠŸ
            return {
                success: true,
                message: 'é ç´„å·²æˆåŠŸå–æ¶ˆ'
            };
        }

        // æŸ¥è©¢é ç´„è³‡æ–™
        async function fetchBookingData() {
            try {
                const result = await callGAS('getBooking', {
                    bookingId: bookingId,
                    userId: userId
                });

                if (result.success) {
                    bookingData = result.data;
                    displayBookingData();
                } else {
                    showError(result.message || 'æ‰¾ä¸åˆ°é ç´„è³‡æ–™');
                }

            } catch (error) {
                console.error('æŸ¥è©¢é ç´„å¤±æ•—:', error);
                showError('æŸ¥è©¢å¤±æ•—ï¼š' + error.message);
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        // é¡¯ç¤ºé ç´„è³‡æ–™
        function displayBookingData() {
            document.getElementById('displayBookingId').textContent = bookingData.bookingId;
            document.getElementById('customerName').textContent = bookingData.name;
            document.getElementById('customerPhone').textContent = bookingData.phone;
            document.getElementById('carPlate').textContent = bookingData.plate;
            document.getElementById('appointmentDate').textContent = formatDate(bookingData.date);
            document.getElementById('appointmentTime').textContent = bookingData.time;
            document.getElementById('serviceType').textContent = bookingData.serviceType;
            document.getElementById('appointmentNote').textContent = bookingData.note || 'ç„¡';
            document.getElementById('createdTime').textContent = formatDateTime(bookingData.timestamp);

            // è¨­å®šç‹€æ…‹
            const statusElement = document.getElementById('bookingStatus');
            const cancelBtn = document.getElementById('cancelBtn');

            if (bookingData.status === 'cancelled') {
                statusElement.textContent = 'å·²å–æ¶ˆ';
                statusElement.className = 'booking-status status-cancelled';
                cancelBtn.style.display = 'none';
            } else {
                statusElement.textContent = 'é ç´„ä¸­';
                statusElement.className = 'booking-status status-active';
                cancelBtn.style.display = 'inline-block';
            }

            document.getElementById('bookingDetails').style.display = 'block';
        }

        // æ ¼å¼åŒ–æ—¥æœŸ
        function formatDate(dateString) {
            const date = new Date(dateString);
            const weekDays = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
            const year = date.getFullYear();
            const month = date.getMonth() + 1;
            const day = date.getDate();
            const weekDay = weekDays[date.getDay()];

            return `${year}/${month}/${day} (${weekDay})`;
        }

        // æ ¼å¼åŒ–æ—¥æœŸæ™‚é–“
        function formatDateTime(timestamp) {
            const date = new Date(timestamp);
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');

            return `${year}/${month}/${day} ${hours}:${minutes}`;
        }

        // é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
        function showError(message) {
            document.getElementById('errorText').textContent = message;
            document.getElementById('errorMessage').style.display = 'block';
            document.getElementById('loading').style.display = 'none';
        }

        // å–æ¶ˆé ç´„
        async function cancelBooking() {
            const cancelBtn = document.getElementById('confirmCancelBtn');
            const originalText = cancelBtn.textContent;
            
            cancelBtn.disabled = true;
            cancelBtn.textContent = 'è™•ç†ä¸­...';

            try {
                const result = await callGAS('cancelBooking', {
                    bookingId: bookingId,
                    userId: userId
                });

                if (result.success) {
                    document.getElementById('cancelModal').style.display = 'none';
                    document.getElementById('successMessage').style.display = 'block';
                    document.getElementById('bookingDetails').style.display = 'none';
                } else {
                    alert('å–æ¶ˆå¤±æ•—ï¼š' + (result.message || 'è«‹ç¨å¾Œå†è©¦'));
                }

            } catch (error) {
                console.error('å–æ¶ˆé ç´„å¤±æ•—:', error);
                alert('å–æ¶ˆå¤±æ•—ï¼š' + error.message);
            } finally {
                cancelBtn.disabled = false;
                cancelBtn.textContent = originalText;
            }
        }

        // äº‹ä»¶ç›£è½å™¨
        document.addEventListener('DOMContentLoaded', function() {
            console.log('é é¢è¼‰å…¥å®Œæˆ');

            // å–å¾— URL åƒæ•¸
            if (!getUrlParameters()) {
                return;
            }

            // åˆå§‹åŒ– LIFF
            initializeLiff();

            // æŸ¥è©¢é ç´„è³‡æ–™
            fetchBookingData();

            // å–æ¶ˆé ç´„æŒ‰éˆ•
            document.getElementById('cancelBtn').addEventListener('click', function() {
                document.getElementById('cancelModal').style.display = 'block';
            });

            // ç¢ºèªå–æ¶ˆæŒ‰éˆ•
            document.getElementById('confirmCancelBtn').addEventListener('click', cancelBooking);

            // å–æ¶ˆå–æ¶ˆæŒ‰éˆ•
            document.getElementById('cancelCancelBtn').addEventListener('click', function() {
                document.getElementById('cancelModal').style.display = 'none';
            });

            // é—œé–‰æŒ‰éˆ•
            document.getElementById('closeBtn').addEventListener('click', function() {
                if (liff && liff.isInClient()) {
                    liff.closeWindow();
                } else {
                    window.history.back();
                }
            });

            // é»æ“Šæ¨¡æ…‹æ¡†å¤–éƒ¨é—œé–‰
            document.getElementById('cancelModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    this.style.display = 'none';
                }
            });
        });

        // æ¨¡æ“¬æ¸¬è©¦å‡½æ•¸
        function testNormalBooking() {
            bookingId = 'A20241211-TEST1';
            userId = 'U123456789test';
            resetPage();
            fetchBookingData();
        }

        function testCancelledBooking() {
            bookingId = 'cancelled';
            userId = 'U123456789test';
            resetPage();
            fetchBookingData();
        }

        function testInvalidBooking() {
            bookingId = 'invalid';
            userId = 'U123456789test';
            resetPage();
            fetchBookingData();
        }

        function resetPage() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('errorMessage').style.display = 'none';
            document.getElementById('successMessage').style.display = 'none';
            document.getElementById('bookingDetails').style.display = 'none';
            updateDebugInfo('bookingIdParam', bookingId + ' (æ¨¡æ“¬)');
            updateDebugInfo('userIdParam', userId + ' (æ¨¡æ“¬)');
        }
    </script>
</body>
</html>