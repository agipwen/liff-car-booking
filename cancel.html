<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>統一汽車 - 預約查詢</title>
    <script src="https://kit.fontawesome.com/ca83b2e10a.js" crossorigin="anonymous"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <link rel="stylesheet" href="cancel.css">
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>統一汽車</h1>
            <p>預約查詢系統</p>
        </header>

        <div class="content">
            <!-- 模擬測試按鈕 -->
            <div class="debug-info" style="background: #e7f3ff; border-color: #007bff;">
                <h3>🚀 模擬測試</h3>
                <p>這是模擬版本，您可以測試不同的情況：</p>
                <div style="margin-top: 10px;">
                    <button onclick="testNormalBooking()" class="btn btn-primary" style="margin: 5px; padding: 8px 15px; font-size: 0.9em;">
                        測試正常預約
                    </button>
                    <button onclick="testCancelledBooking()" class="btn btn-secondary" style="margin: 5px; padding: 8px 15px; font-size: 0.9em;">
                        測試已取消預約
                    </button>
                    <button onclick="testInvalidBooking()" class="btn btn-danger" style="margin: 5px; padding: 8px 15px; font-size: 0.9em;">
                        測試無效預約
                    </button>
                </div>
            </div>

            <!-- 除錯資訊 -->
            <div class="debug-info">
                <h3>🔍 除錯檢查</h3>
                <div>預約編號: <span id="bookingIdParam">未取得</span></div>
                <div>用戶ID: <span id="userIdParam">未取得</span></div>
                <div>API URL: <span id="apiUrlDebug">未設定</span></div>
                <div>LIFF 狀態: <span id="liffStatus">檢查中...</span></div>
                <div>最後錯誤: <span id="lastError">無</span></div>
            </div>

            <!-- 載入中 -->
            <div id="loading" class="loading">
                <i class="fas fa-spinner"></i>
                <p>查詢預約資料中...</p>
            </div>

            <!-- 錯誤訊息 -->
            <div id="errorMessage" class="error-message" style="display: none;">
                <i class="fas fa-exclamation-triangle"></i>
                <h3>查詢失敗</h3>
                <p id="errorText"></p>
            </div>

            <!-- 成功取消訊息 -->
            <div id="successMessage" class="success-message" style="display: none;">
                <i class="fas fa-check-circle"></i>
                <h3>預約已取消</h3>
                <p>您的預約已成功取消</p>
            </div>

            <!-- 預約詳情 -->
            <div id="bookingDetails" class="booking-details" style="display: none;">
                <div class="booking-header">
                    <div class="booking-id">預約編號：<span id="displayBookingId"></span></div>
                    <div class="booking-status" id="bookingStatus"></div>
                </div>

                <div class="detail-grid">
                    <div class="detail-item">
                        <div class="detail-label">預約人姓名</div>
                        <div class="detail-value" id="customerName"></div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">聯絡電話</div>
                        <div class="detail-value" id="customerPhone"></div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">車牌號碼</div>
                        <div class="detail-value highlight" id="carPlate"></div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">預約日期</div>
                        <div class="detail-value highlight" id="appointmentDate"></div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">預約時間</div>
                        <div class="detail-value highlight" id="appointmentTime"></div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">服務項目</div>
                        <div class="detail-value" id="serviceType"></div>
                    </div>
                    <div class="detail-item" style="grid-column: 1 / -1;">
                        <div class="detail-label">備註</div>
                        <div class="detail-value" id="appointmentNote">無</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">預約建立時間</div>
                        <div class="detail-value" id="createdTime"></div>
                    </div>
                </div>

                <div class="action-buttons">
                    <button id="cancelBtn" class="btn btn-danger">
                        <i class="fas fa-times"></i> 取消預約
                    </button>
                    <button id="closeBtn" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> 返回
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 取消確認對話框 -->
    <div id="cancelModal" class="modal">
        <div class="modal-content">
            <h3><i class="fas fa-exclamation-triangle"></i> 確認取消預約</h3>
            <p>您確定要取消這個預約嗎？此操作無法復原。</p>
            <div class="modal-buttons">
                <button id="confirmCancelBtn" class="btn btn-danger">確認取消</button>
                <button id="cancelCancelBtn" class="btn btn-secondary">保留預約</button>
            </div>
        </div>
    </div>

    <script>
        // 請使用與預約頁面相同的 GAS URL
        const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzAhNvgzW5ZqPteINKHd69LpE3rK2L28htSfENqKncvgOh3UKh5DOEkaUEpp8Pj86BF/exec';

        // 全域變數
        let bookingId = null;
        let userId = null;
        let bookingData = null;
        let liffProfile = null;

        // 更新除錯資訊
        function updateDebugInfo(key, value) {
            const element = document.getElementById(key);
            if (element) {
                element.textContent = value;
            }
        }

        // 記錄錯誤
        function logError(error) {
            console.error('錯誤:', error);
            updateDebugInfo('lastError', error.message || error);
        }

        // 從 URL 取得參數 (模擬版本)
        function getUrlParameters() {
            const urlParams = new URLSearchParams(window.location.search);
            bookingId = urlParams.get('bookingId');
            userId = urlParams.get('userId');

            // 如果沒有參數，使用模擬資料
            if (!bookingId) {
                bookingId = 'A20241211-TEST1';
                console.log('使用模擬預約編號:', bookingId);
            }
            if (!userId) {
                userId = 'U123456789test';
                console.log('使用模擬用戶ID:', userId);
            }

            updateDebugInfo('bookingIdParam', bookingId + ' (模擬)');
            updateDebugInfo('userIdParam', userId + ' (模擬)');

            return true;
        }

        // 初始化 LIFF
        async function initializeLiff() {
            try {
                updateDebugInfo('liffStatus', '初始化中...');

                if (typeof liff === 'undefined') {
                    updateDebugInfo('liffStatus', 'LIFF SDK 未載入');
                    return;
                }

                await liff.init({
                    liffId: '2007724265-YJ80zrNX'
                });

                updateDebugInfo('liffStatus', '已連接');

                if (liff.isLoggedIn()) {
                    const profile = await liff.getProfile();
                    liffProfile = profile;
                    updateDebugInfo('liffStatus', '已登入');
                } else {
                    updateDebugInfo('liffStatus', '未登入');
                }

            } catch (error) {
                logError(error);
                updateDebugInfo('liffStatus', '失敗: ' + error.message);
            }
        }

        // 調用 Google Apps Script (模擬版本)
        async function callGAS(action, data) {
            try {
                updateDebugInfo('apiUrlDebug', GAS_WEB_APP_URL + ' (模擬模式)');

                const payload = {
                    action: action,
                    ...data
                };

                console.log('發送到 GAS (模擬):', payload);

                // 模擬網路延遲
                await new Promise(resolve => setTimeout(resolve, 1000));

                // 模擬不同的回應
                let result;
                if (action === 'getBooking') {
                    result = mockGetBooking(data);
                } else if (action === 'cancelBooking') {
                    result = mockCancelBooking(data);
                } else {
                    result = { success: false, message: '未知的操作' };
                }

                console.log('GAS 回應 (模擬):', result);
                return result;

            } catch (error) {
                console.error('GAS API 調用失敗:', error);
                logError(error);
                throw error;
            }
        }

        // 模擬查詢預約資料
        function mockGetBooking(data) {
            const { bookingId, userId } = data;
            
            // 模擬不同的情況
            if (!bookingId || bookingId === 'invalid') {
                return {
                    success: false,
                    message: '找不到預約資料，請檢查預約編號'
                };
            }

            if (bookingId === 'cancelled') {
                return {
                    success: true,
                    data: {
                        bookingId: 'A20241211-XYZ99',
                        name: '王小明',
                        phone: '0912-345-678',
                        plate: 'ABC-1234',
                        date: '2024-12-15',
                        time: '10:00',
                        serviceType: '保養',
                        note: '第一次來訪，Toyota Camry 2020年',
                        timestamp: '2024-12-11T10:30:00.000Z',
                        status: 'cancelled'
                    }
                };
            }

            // 預設返回正常預約資料
            return {
                success: true,
                data: {
                    bookingId: bookingId,
                    name: '張大華',
                    phone: '0987-654-321',
                    plate: 'DEF-5678',
                    date: '2024-12-20',
                    time: '14:30',
                    serviceType: '維修',
                    note: '煞車異音需要檢查',
                    timestamp: '2024-12-11T09:15:00.000Z',
                    status: 'active'
                }
            };
        }

        // 模擬取消預約
        function mockCancelBooking(data) {
            const { bookingId, userId } = data;
            
            // 模擬取消成功
            return {
                success: true,
                message: '預約已成功取消'
            };
        }

        // 查詢預約資料
        async function fetchBookingData() {
            try {
                const result = await callGAS('getBooking', {
                    bookingId: bookingId,
                    userId: userId
                });

                if (result.success) {
                    bookingData = result.data;
                    displayBookingData();
                } else {
                    showError(result.message || '找不到預約資料');
                }

            } catch (error) {
                console.error('查詢預約失敗:', error);
                showError('查詢失敗：' + error.message);
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        // 顯示預約資料
        function displayBookingData() {
            document.getElementById('displayBookingId').textContent = bookingData.bookingId;
            document.getElementById('customerName').textContent = bookingData.name;
            document.getElementById('customerPhone').textContent = bookingData.phone;
            document.getElementById('carPlate').textContent = bookingData.plate;
            document.getElementById('appointmentDate').textContent = formatDate(bookingData.date);
            document.getElementById('appointmentTime').textContent = bookingData.time;
            document.getElementById('serviceType').textContent = bookingData.serviceType;
            document.getElementById('appointmentNote').textContent = bookingData.note || '無';
            document.getElementById('createdTime').textContent = formatDateTime(bookingData.timestamp);

            // 設定狀態
            const statusElement = document.getElementById('bookingStatus');
            const cancelBtn = document.getElementById('cancelBtn');

            if (bookingData.status === 'cancelled') {
                statusElement.textContent = '已取消';
                statusElement.className = 'booking-status status-cancelled';
                cancelBtn.style.display = 'none';
            } else {
                statusElement.textContent = '預約中';
                statusElement.className = 'booking-status status-active';
                cancelBtn.style.display = 'inline-block';
            }

            document.getElementById('bookingDetails').style.display = 'block';
        }

        // 格式化日期
        function formatDate(dateString) {
            const date = new Date(dateString);
            const weekDays = ['日', '一', '二', '三', '四', '五', '六'];
            const year = date.getFullYear();
            const month = date.getMonth() + 1;
            const day = date.getDate();
            const weekDay = weekDays[date.getDay()];

            return `${year}/${month}/${day} (${weekDay})`;
        }

        // 格式化日期時間
        function formatDateTime(timestamp) {
            const date = new Date(timestamp);
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');

            return `${year}/${month}/${day} ${hours}:${minutes}`;
        }

        // 顯示錯誤訊息
        function showError(message) {
            document.getElementById('errorText').textContent = message;
            document.getElementById('errorMessage').style.display = 'block';
            document.getElementById('loading').style.display = 'none';
        }

        // 取消預約
        async function cancelBooking() {
            const cancelBtn = document.getElementById('confirmCancelBtn');
            const originalText = cancelBtn.textContent;
            
            cancelBtn.disabled = true;
            cancelBtn.textContent = '處理中...';

            try {
                const result = await callGAS('cancelBooking', {
                    bookingId: bookingId,
                    userId: userId
                });

                if (result.success) {
                    document.getElementById('cancelModal').style.display = 'none';
                    document.getElementById('successMessage').style.display = 'block';
                    document.getElementById('bookingDetails').style.display = 'none';
                } else {
                    alert('取消失敗：' + (result.message || '請稍後再試'));
                }

            } catch (error) {
                console.error('取消預約失敗:', error);
                alert('取消失敗：' + error.message);
            } finally {
                cancelBtn.disabled = false;
                cancelBtn.textContent = originalText;
            }
        }

        // 事件監聽器
        document.addEventListener('DOMContentLoaded', function() {
            console.log('頁面載入完成');

            // 取得 URL 參數
            if (!getUrlParameters()) {
                return;
            }

            // 初始化 LIFF
            initializeLiff();

            // 查詢預約資料
            fetchBookingData();

            // 取消預約按鈕
            document.getElementById('cancelBtn').addEventListener('click', function() {
                document.getElementById('cancelModal').style.display = 'block';
            });

            // 確認取消按鈕
            document.getElementById('confirmCancelBtn').addEventListener('click', cancelBooking);

            // 取消取消按鈕
            document.getElementById('cancelCancelBtn').addEventListener('click', function() {
                document.getElementById('cancelModal').style.display = 'none';
            });

            // 關閉按鈕
            document.getElementById('closeBtn').addEventListener('click', function() {
                if (liff && liff.isInClient()) {
                    liff.closeWindow();
                } else {
                    window.history.back();
                }
            });

            // 點擊模態框外部關閉
            document.getElementById('cancelModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    this.style.display = 'none';
                }
            });
        });

        // 模擬測試函數
        function testNormalBooking() {
            bookingId = 'A20241211-TEST1';
            userId = 'U123456789test';
            resetPage();
            fetchBookingData();
        }

        function testCancelledBooking() {
            bookingId = 'cancelled';
            userId = 'U123456789test';
            resetPage();
            fetchBookingData();
        }

        function testInvalidBooking() {
            bookingId = 'invalid';
            userId = 'U123456789test';
            resetPage();
            fetchBookingData();
        }

        function resetPage() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('errorMessage').style.display = 'none';
            document.getElementById('successMessage').style.display = 'none';
            document.getElementById('bookingDetails').style.display = 'none';
            updateDebugInfo('bookingIdParam', bookingId + ' (模擬)');
            updateDebugInfo('userIdParam', userId + ' (模擬)');
        }
    </script>
</body>
</html>