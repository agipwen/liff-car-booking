<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çµ±ä¸€æ±½è»Š - é ç´„æŸ¥è©¢</title>
    <script src="https://kit.fontawesome.com/ca83b2e10a.js" crossorigin="anonymous"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <link rel="stylesheet" href="cancel.css">
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>çµ±ä¸€æ±½è»Š</h1>
            <p>é ç´„æŸ¥è©¢ç³»çµ±</p>
        </header>

        <div class="content">
            <!-- é™¤éŒ¯è³‡è¨Š (éš±è—) -->
            <div class="debug-info" style="display: none;">
                <h3>ğŸ” ç‹€æ…‹æª¢æŸ¥</h3>
                <div>æœ€å¾ŒéŒ¯èª¤: <span id="lastError">ç„¡</span></div>
                <div>è«‹æ±‚ç‹€æ…‹: <span id="requestStatus">æœªé–‹å§‹</span></div>
                <div>LIFF ç‹€æ…‹: <span id="liffStatus">æª¢æŸ¥ä¸­...</span></div>
            </div>

            <!-- è¼‰å…¥ä¸­ -->
            <div id="loading" class="loading">
                <i class="fas fa-spinner"></i>
                <p>æŸ¥è©¢é ç´„è³‡æ–™ä¸­...</p>
            </div>

            <!-- éŒ¯èª¤è¨Šæ¯ -->
            <div id="errorMessage" class="error-message" style="display: none;">
                <i class="fas fa-exclamation-triangle"></i>
                <h3>æŸ¥è©¢å¤±æ•—</h3>
                <p id="errorText"></p>
            </div>

            <!-- æˆåŠŸå–æ¶ˆè¨Šæ¯ -->
            <div id="successMessage" class="success-message" style="display: none;">
                <i class="fas fa-check-circle"></i>
                <h3>é ç´„å·²å–æ¶ˆ</h3>
                <p>æ‚¨çš„é ç´„å·²æˆåŠŸå–æ¶ˆ</p>
            </div>

            <!-- é ç´„è©³æƒ… -->
            <div id="bookingDetails" class="booking-details" style="display: none;">
                <div class="booking-header">
                    <div class="booking-id">é ç´„ç·¨è™Ÿï¼š<span id="displayBookingId"></span></div>
                    <div class="booking-status" id="bookingStatus"></div>
                </div>

                <div class="detail-grid">
                    <div class="detail-item">
                        <div class="detail-label">é ç´„äººå§“å</div>
                        <div class="detail-value" id="customerName"></div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">è¯çµ¡é›»è©±</div>
                        <div class="detail-value" id="customerPhone"></div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">è»Šç‰Œè™Ÿç¢¼</div>
                        <div class="detail-value highlight" id="carPlate"></div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">é ç´„æ—¥æœŸ</div>
                        <div class="detail-value highlight" id="appointmentDate"></div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">é ç´„æ™‚é–“</div>
                        <div class="detail-value highlight" id="appointmentTime"></div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">æœå‹™é …ç›®</div>
                        <div class="detail-value" id="serviceType"></div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">å‚™è¨»</div>
                        <div class="detail-value" id="appointmentNote">ç„¡</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">é ç´„å»ºç«‹æ™‚é–“</div>
                        <div class="detail-value" id="createdTime"></div>
                    </div>
                </div>

                <div class="action-buttons">
                    <button id="cancelBtn" class="btn btn-danger">
                        <i class="fas fa-times"></i> å–æ¶ˆé ç´„
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- å–æ¶ˆç¢ºèªå°è©±æ¡† -->
    <div id="cancelModal" class="modal">
        <div class="modal-content">
            <h3><i class="fas fa-exclamation-triangle"></i> ç¢ºèªå–æ¶ˆé ç´„</h3>
            <p>æ‚¨ç¢ºå®šè¦å–æ¶ˆé€™å€‹é ç´„å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚</p>
            <div class="modal-buttons">
                <button id="confirmCancelBtn" class="btn btn-danger">ç¢ºèªå–æ¶ˆ</button>
                <button id="cancelCancelBtn" class="btn btn-secondary">ä¿ç•™é ç´„</button>
            </div>
        </div>
    </div>

    <script>
        // ğŸ”§ è«‹å°‡æ­¤è™•æ›¿æ›ç‚ºæ‚¨é‡æ–°éƒ¨ç½²å¾Œçš„æ–° URL
        const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzAhNvgzW5ZqPteINKHd69LpE3rK2L28htSfENqKncvgOh3UKh5DOEkaUEpp8Pj86BF/exec';
        let bookingId = null;
        let userId = null;
        let bookingData = null;

        function updateDebugInfo(key, value) {
            const element = document.getElementById(key);
            if (element) element.textContent = value;
        }

        function logError(error) {
            console.error('éŒ¯èª¤:', error);
            updateDebugInfo('lastError', error.message || error);
        }

        function getUrlParameters() {
            const urlParams = new URLSearchParams(window.location.search);
            bookingId = urlParams.get('bookingId');
            userId = urlParams.get('userId');

            console.log('URL åƒæ•¸:', { bookingId, userId });
            // updateDebugInfo('bookingIdParam', bookingId || 'æœªæä¾›');
            // updateDebugInfo('userIdParam', userId || 'æœªæä¾›');

            if (!bookingId || !userId) {
                showError('ç¼ºå°‘å¿…è¦çš„ bookingId æˆ– userId åƒæ•¸');
                document.getElementById('loading').style.display = 'none';
                return false;
            }

            return true;
        }

        async function initializeLiff() {
            try {
                updateDebugInfo('liffStatus', 'åˆå§‹åŒ–ä¸­...');
                
                // æœ¬åœ°æ¸¬è©¦æ¨¡å¼
                if (window.location.hostname === '127.0.0.1' || window.location.hostname === 'localhost') {
                    updateDebugInfo('liffStatus', 'æœ¬åœ°æ¸¬è©¦æ¨¡å¼');
                    return;
                }
                
                // å¯¦éš›çš„ LIFF åˆå§‹åŒ–
                if (typeof liff !== 'undefined') {
                    await liff.init({ liffId: '2007724265-YJ80zrNX' });
                    if (liff.isLoggedIn()) {
                        updateDebugInfo('liffStatus', 'å·²ç™»å…¥');
                    } else {
                        updateDebugInfo('liffStatus', 'æœªç™»å…¥');
                    }
                } else {
                    updateDebugInfo('liffStatus', 'LIFF SDK æœªè¼‰å…¥');
                }
            } catch (error) {
                logError(error);
                updateDebugInfo('liffStatus', 'å¤±æ•—: ' + error.message);
            }
        }

        async function callGAS(action, data) {
            try {
                const payload = { action, ...data };
                console.log('ç™¼é€åˆ° GAS çš„è³‡æ–™:', payload);
                updateDebugInfo('requestStatus', 'ç™¼é€ä¸­...');

                // ğŸ”§ ä¿®æ”¹ fetch é¸é …ï¼Œç§»é™¤å¯èƒ½é€ æˆé æª¢è«‹æ±‚çš„æ¨™é ­
                const response = await fetch(GAS_WEB_APP_URL, {
                    method: 'POST',
                    body: JSON.stringify(payload),
                    // ç§»é™¤ Content-Type æ¨™é ­ä»¥é¿å…é æª¢è«‹æ±‚
                    redirect: 'follow'
                });

                // updateDebugInfo('responseStatus', `HTTP ${response.status}`);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();
                // updateDebugInfo('apiUrlDebug', GAS_WEB_APP_URL);
                updateDebugInfo('requestStatus', 'å®Œæˆ');
                
                console.log('GAS å›æ‡‰:', result);
                
                return result;

            } catch (error) {
                console.error('GAS API èª¿ç”¨å¤±æ•—:', error);
                updateDebugInfo('requestStatus', 'å¤±æ•—: ' + error.message);
                logError(error);
                throw error;
            }
        }

        async function fetchBookingData() {
            try {
                console.log('é–‹å§‹æŸ¥è©¢é ç´„è³‡æ–™...', { bookingId, userId });
                
                const result = await callGAS('getBooking', {
                    bookingId: bookingId,
                    userId: userId
                });

                console.log('æŸ¥è©¢çµæœ:', result);

                if (result.success) {
                    bookingData = result.data;
                    displayBookingData();
                } else {
                    showError(result.message || 'æ‰¾ä¸åˆ°é ç´„è³‡æ–™');
                }

            } catch (error) {
                console.error('æŸ¥è©¢é ç´„å¤±æ•—:', error);
                showError('æŸ¥è©¢å¤±æ•—ï¼š' + error.message);
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        function displayBookingData() {
            console.log('é¡¯ç¤ºé ç´„è³‡æ–™:', bookingData);
            
            // ç¢ºä¿æ‰€æœ‰æ¬„ä½éƒ½æœ‰å€¼
            document.getElementById('displayBookingId').textContent = bookingData.bookingId || 'ç„¡';
            document.getElementById('customerName').textContent = bookingData.name || 'ç„¡';
            document.getElementById('customerPhone').textContent = bookingData.phone || 'ç„¡';
            document.getElementById('carPlate').textContent = bookingData.plate || 'ç„¡';
            document.getElementById('appointmentDate').textContent = formatDate(bookingData.date);
            document.getElementById('appointmentTime').textContent = formatTime(bookingData.time) || 'ç„¡';
            document.getElementById('serviceType').textContent = bookingData.serviceType || 'ç„¡';
            document.getElementById('appointmentNote').textContent = bookingData.note || 'ç„¡';
            
            // è™•ç†å»ºç«‹æ™‚é–“
            const createdTime = bookingData.timestamp || bookingData.createdAt || bookingData.createdTime;
            if (createdTime) {
                document.getElementById('createdTime').textContent = formatDateTime(createdTime);
            } else {
                document.getElementById('createdTime').textContent = 'ç„¡è³‡æ–™';
            }

            const statusElement = document.getElementById('bookingStatus');
            const cancelBtn = document.getElementById('cancelBtn');

            if (bookingData.status === 'cancelled' || bookingData.status === 'å·²å–æ¶ˆ') {
                statusElement.textContent = 'å·²å–æ¶ˆ';
                statusElement.className = 'booking-status status-cancelled';
                cancelBtn.style.display = 'none';
            } else {
                statusElement.textContent = 'é ç´„ä¸­';
                statusElement.className = 'booking-status status-active';
                cancelBtn.style.display = 'inline-block';
            }

            document.getElementById('bookingDetails').style.display = 'block';
        }

        function formatTime(timeString) {
            if (!timeString) return 'ç„¡';
            
            try {
                // å¦‚æœå·²ç¶“æ˜¯æ¨™æº–æ™‚é–“æ ¼å¼ (HH:MM æˆ– H:MM)
                if (timeString.match(/^\d{1,2}:\d{2}$/)) {
                    return timeString;
                }
                
                // å¦‚æœæ˜¯ ISO æ ¼å¼çš„æ™‚é–“æˆ³ (é€šå¸¸æ˜¯éŒ¯èª¤çš„)
                if (timeString.includes('T') && timeString.includes('Z')) {
                    const date = new Date(timeString);
                    
                    // æª¢æŸ¥æ˜¯å¦ç‚ºæœ‰æ•ˆæ—¥æœŸ
                    if (isNaN(date.getTime())) {
                        return 'æ™‚é–“æ ¼å¼éŒ¯èª¤';
                    }
                    
                    // å¦‚æœæ˜¯ 1899 å¹´ï¼Œé€™é€šå¸¸æ˜¯ Excel åºåˆ—è™Ÿå•é¡Œ
                    if (date.getFullYear() < 1900) {
                        // å˜—è©¦å¾æ™‚é–“æˆ³ä¸­æå–æ™‚é–“éƒ¨åˆ†
                        const timeOnly = date.toISOString().split('T')[1];
                        const timePart = timeOnly.split(':');
                        const hours = parseInt(timePart[0]);
                        const minutes = parseInt(timePart[1]);
                        
                        // èª¿æ•´æ™‚å€ (å‡è¨­æ˜¯ UTC+8)
                        let adjustedHours = hours + 8;
                        if (adjustedHours >= 24) adjustedHours -= 24;
                        if (adjustedHours < 0) adjustedHours += 24;
                        
                        return `${String(adjustedHours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
                    }
                    
                    // æ­£å¸¸çš„ ISO æ™‚é–“æˆ³ï¼Œè½‰æ›ç‚ºå°ç£æ™‚é–“
                    const taiwanTime = new Date(date.getTime() + (8 * 60 * 60 * 1000));
                    return `${String(taiwanTime.getUTCHours()).padStart(2, '0')}:${String(taiwanTime.getUTCMinutes()).padStart(2, '0')}`;
                }
                
                // å¦‚æœæ˜¯æ•¸å­—ï¼ˆExcel åºåˆ—è™Ÿï¼‰
                if (!isNaN(timeString)) {
                    const num = parseFloat(timeString);
                    
                    // Excel æ™‚é–“åºåˆ—è™Ÿè½‰æ›ï¼ˆå°æ•¸éƒ¨åˆ†ä»£è¡¨ä¸€å¤©ä¸­çš„æ™‚é–“ï¼‰
                    if (num >= 0 && num < 1) {
                        const totalMinutes = Math.round(num * 24 * 60);
                        const hours = Math.floor(totalMinutes / 60);
                        const minutes = totalMinutes % 60;
                        return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
                    }
                }
                
                // å…¶ä»–æƒ…æ³ï¼Œå˜—è©¦è§£æç‚ºæ™‚é–“
                console.log('æœªçŸ¥æ™‚é–“æ ¼å¼:', timeString);
                return timeString;
                
            } catch (error) {
                console.error('æ™‚é–“æ ¼å¼åŒ–éŒ¯èª¤:', error, 'åŸå§‹å€¼:', timeString);
                return 'æ™‚é–“æ ¼å¼éŒ¯èª¤';
            }
        }

        function formatDate(dateString) {
            if (!dateString) return 'ç„¡';
            
            try {
                // è™•ç†ä¸åŒçš„æ—¥æœŸæ ¼å¼
                let date;
                if (dateString.includes('/')) {
                    // æ ¼å¼ï¼š2025/07/12
                    const parts = dateString.split('/');
                    date = new Date(parts[0], parts[1] - 1, parts[2]);
                } else if (dateString.includes('-')) {
                    // æ ¼å¼ï¼š2025-07-12
                    date = new Date(dateString);
                } else {
                    return dateString;
                }
                
                if (isNaN(date.getTime())) {
                    return dateString;
                }
                
                const weekDays = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
                return `${date.getFullYear()}/${String(date.getMonth()+1).padStart(2, '0')}/${String(date.getDate()).padStart(2, '0')} (${weekDays[date.getDay()]})`;
            } catch (error) {
                console.error('æ—¥æœŸæ ¼å¼åŒ–éŒ¯èª¤:', error);
                return dateString;
            }
        }

        function formatDateTime(timestamp) {
            if (!timestamp) return 'ç„¡';
            
            try {
                const date = new Date(timestamp);
                if (isNaN(date.getTime())) {
                    return timestamp;
                }
                return `${date.getFullYear()}/${String(date.getMonth()+1).padStart(2,'0')}/${String(date.getDate()).padStart(2,'0')} ${String(date.getHours()).padStart(2,'0')}:${String(date.getMinutes()).padStart(2,'0')}`;
            } catch (error) {
                console.error('æ™‚é–“æ ¼å¼åŒ–éŒ¯èª¤:', error);
                return timestamp;
            }
        }

        function showError(message) {
            document.getElementById('errorText').textContent = message;
            document.getElementById('errorMessage').style.display = 'block';
            document.getElementById('loading').style.display = 'none';
        }

        async function cancelBooking() {
            const cancelBtn = document.getElementById('confirmCancelBtn');
            cancelBtn.disabled = true;
            cancelBtn.textContent = 'è™•ç†ä¸­...';

            try {
                const result = await callGAS('cancelBooking', {
                    bookingId: bookingId,
                    userId: userId
                });

                if (result.success) {
                    document.getElementById('cancelModal').style.display = 'none';
                    document.getElementById('successMessage').style.display = 'block';
                    document.getElementById('bookingDetails').style.display = 'none';
                } else {
                    alert('å–æ¶ˆå¤±æ•—ï¼š' + (result.message || 'è«‹ç¨å¾Œå†è©¦'));
                }

            } catch (error) {
                console.error('å–æ¶ˆé ç´„å¤±æ•—:', error);
                alert('å–æ¶ˆå¤±æ•—ï¼š' + error.message);
            } finally {
                cancelBtn.disabled = false;
                cancelBtn.textContent = 'ç¢ºèªå–æ¶ˆ';
            }
        }

        // æ¸¬è©¦ API é€£æ¥
        async function testApiConnection() {
            try {
                console.log('æ¸¬è©¦ API é€£æ¥...');
                updateDebugInfo('requestStatus', 'æ¸¬è©¦é€£æ¥...');
                
                const result = await callGAS('testConnection', {});
                console.log('API é€£æ¥æ¸¬è©¦çµæœ:', result);
                
                if (result.success) {
                    updateDebugInfo('requestStatus', 'API é€£æ¥æ­£å¸¸');
                } else {
                    updateDebugInfo('requestStatus', 'API é€£æ¥å¤±æ•—');
                }
            } catch (error) {
                console.error('API é€£æ¥æ¸¬è©¦å¤±æ•—:', error);
                updateDebugInfo('requestStatus', 'API é€£æ¥æ¸¬è©¦å¤±æ•—');
            }
        }

        document.addEventListener('DOMContentLoaded', function () {
            console.log('é é¢è¼‰å…¥å®Œæˆï¼Œé–‹å§‹åˆå§‹åŒ–...');
            
            // å…ˆæ¸¬è©¦ API é€£æ¥
            testApiConnection();
            
            if (!getUrlParameters()) return;
            
            initializeLiff().then(() => {
                console.log('LIFF åˆå§‹åŒ–å®Œæˆï¼Œé–‹å§‹æŸ¥è©¢é ç´„è³‡æ–™...');
                fetchBookingData();
            }).catch(error => {
                console.error('LIFF åˆå§‹åŒ–å¤±æ•—:', error);
                // å³ä½¿ LIFF åˆå§‹åŒ–å¤±æ•—ï¼Œä»ç„¶å˜—è©¦æŸ¥è©¢é ç´„è³‡æ–™
                fetchBookingData();
            });

            // äº‹ä»¶ç›£è½å™¨
            document.getElementById('cancelBtn').addEventListener('click', () => {
                document.getElementById('cancelModal').style.display = 'block';
            });

            document.getElementById('confirmCancelBtn').addEventListener('click', cancelBooking);
            
            document.getElementById('cancelCancelBtn').addEventListener('click', () => {
                document.getElementById('cancelModal').style.display = 'none';
            });

            document.getElementById('closeBtn').addEventListener('click', () => {
                if (typeof liff !== 'undefined' && liff.isInClient()) {
                    liff.closeWindow();
                } else {
                    window.history.back();
                }
            });

            document.getElementById('cancelModal').addEventListener('click', function(e) {
                if (e.target === this) this.style.display = 'none';
            });
        });
    </script>
</body>
</html>