<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çµ±ä¸€æ±½è»Š - é ç´„æŸ¥è©¢</title>
    <script src="https://kit.fontawesome.com/ca83b2e10a.js" crossorigin="anonymous"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <link rel="stylesheet" href="cancel.css">
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>çµ±ä¸€æ±½è»Š</h1>
            <p>æŸ¥çœ‹/å–æ¶ˆé ç´„</p>
        </header>

        <div class="content">
            <!-- é™¤éŒ¯è³‡è¨Š (éš±è—) -->
            <div class="debug-info" style="display: none;">
                <h3>ğŸ” ç‹€æ…‹æª¢æŸ¥</h3>
                <div>æœ€å¾ŒéŒ¯èª¤: <span id="lastError">ç„¡</span></div>
                <div>è«‹æ±‚ç‹€æ…‹: <span id="requestStatus">æœªé–‹å§‹</span></div>
                <div>LIFF ç‹€æ…‹: <span id="liffStatus">æª¢æŸ¥ä¸­...</span></div>
                <div>URL Fragment: <span id="fragmentDebug">æª¢æŸ¥ä¸­...</span></div>
                <div>è§£æåƒæ•¸: <span id="paramsDebug">æª¢æŸ¥ä¸­...</span></div>
            </div>

            <!-- è¼‰å…¥ä¸­ -->
            <div id="loading" class="loading">
                <i class="fas fa-spinner"></i>
                <p>æŸ¥è©¢é ç´„è³‡æ–™ä¸­...</p>
            </div>

            <!-- éŒ¯èª¤è¨Šæ¯ -->
            <div id="errorMessage" class="error-message" style="display: none;">
                <i class="fas fa-exclamation-triangle"></i>
                <h3>æŸ¥è©¢å¤±æ•—</h3>
                <p id="errorText"></p>
            </div>

            <!-- æˆåŠŸå–æ¶ˆè¨Šæ¯ -->
            <div id="successMessage" class="success-message" style="display: none;">
                <i class="fas fa-check-circle"></i>
                <h3>é ç´„å·²å–æ¶ˆ</h3>
                <p>æ‚¨çš„é ç´„å·²æˆåŠŸå–æ¶ˆ</p>
            </div>

            <!-- é ç´„è©³æƒ… -->
            <div id="bookingDetails" class="booking-details" style="display: none;">
                <div class="booking-header">
                    <div class="booking-id"><span id="displayBookingId"></span></div>
                    <div class="booking-status" id="bookingStatus"></div>
                </div>

                <div class="detail-grid">
                    <div class="detail-item">
                        <div class="detail-label">é ç´„äººå§“å</div>
                        <div class="detail-value" id="customerName"></div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">è¯çµ¡é›»è©±</div>
                        <div class="detail-value" id="customerPhone"></div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">è»Šç‰Œè™Ÿç¢¼</div>
                        <div class="detail-value highlight" id="carPlate"></div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">é ç´„æ—¥æœŸ</div>
                        <div class="detail-value highlight" id="appointmentDate"></div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">é ç´„æ™‚é–“</div>
                        <div class="detail-value highlight" id="appointmentTime"></div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">æœå‹™é …ç›®</div>
                        <div class="detail-value" id="serviceType"></div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">å‚™è¨»</div>
                        <div class="detail-value" id="appointmentNote">ç„¡</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">é ç´„å»ºç«‹æ™‚é–“</div>
                        <div class="detail-value" id="createdTime"></div>
                    </div>
                </div>

                <div class="action-buttons">
                    <button id="cancelBtn" class="btn btn-danger">
                        <i class="fas fa-times"></i> å–æ¶ˆé ç´„
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- å–æ¶ˆç¢ºèªå°è©±æ¡† -->
    <div id="cancelModal" class="modal">
        <div class="modal-content">
            <h3><i class="fas fa-exclamation-triangle"></i> ç¢ºèªå–æ¶ˆé ç´„</h3>
            <p>æ‚¨ç¢ºå®šè¦å–æ¶ˆé€™å€‹é ç´„å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚</p>
            <div class="modal-buttons">
                <button id="confirmCancelBtn" class="btn btn-danger">ç¢ºèªå–æ¶ˆ</button>
                <button id="cancelCancelBtn" class="btn btn-secondary">ä¿ç•™é ç´„</button>
            </div>
        </div>
    </div>

    <script>
        // ğŸ”§ è«‹å°‡æ­¤è™•æ›¿æ›ç‚ºæ‚¨é‡æ–°éƒ¨ç½²å¾Œçš„æ–° URL
        const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzAhNvgzW5ZqPteINKHd69LpE3rK2L28htSfENqKncvgOh3UKh5DOEkaUEpp8Pj86BF/exec';
        let bookingId = null;
        let userId = null;
        let bookingData = null;

        function updateDebugInfo(key, value) {
            const element = document.getElementById(key);
            if (element) element.textContent = value;
        }

        function logError(error) {
            console.error('éŒ¯èª¤:', error);
            updateDebugInfo('lastError', error.message || error);
        }

        // ğŸ”§ ä¿®æ”¹åƒæ•¸ç²å–æ–¹å¼ï¼šæ”¯æ´ fragment å’Œ query parameters
        function getUrlParameters() {
            console.log('å®Œæ•´ URL:', window.location.href);
            console.log('Fragment:', window.location.hash);
            console.log('Search:', window.location.search);
            
            // æ›´æ–°é™¤éŒ¯è³‡è¨Š
            updateDebugInfo('fragmentDebug', window.location.hash || 'ç„¡');
            
            // æ–¹æ³•1: å˜—è©¦å¾ fragment (#) ç²å–åƒæ•¸
            if (window.location.hash) {
                const fragment = window.location.hash.substring(1); // ç§»é™¤ # ç¬¦è™Ÿ
                console.log('è§£æ fragment:', fragment);
                
                // æª¢æŸ¥æ˜¯å¦ç‚º BASE64 ç·¨ç¢¼çš„åƒæ•¸
                if (fragment.startsWith('params=')) {
                    try {
                        const base64Params = fragment.substring(7); // ç§»é™¤ 'params='
                        const decodedParams = JSON.parse(atob(base64Params));
                        bookingId = decodedParams.bookingId;
                        userId = decodedParams.userId;
                        console.log('å¾ BASE64 è§£æåƒæ•¸:', { bookingId, userId });
                    } catch (error) {
                        console.error('BASE64 è§£æå¤±æ•—:', error);
                    }
                } else {
                    // æ™®é€šçš„ key=value&key=value æ ¼å¼
                    const fragmentParams = new URLSearchParams(fragment);
                    bookingId = fragmentParams.get('bookingId');
                    userId = fragmentParams.get('userId');
                    console.log('å¾ fragment è§£æåƒæ•¸:', { bookingId, userId });
                }
            }
            
            // æ–¹æ³•2: å¦‚æœ fragment æ²’æœ‰åƒæ•¸ï¼Œå˜—è©¦å¾ query parameters ç²å–
            if (!bookingId || !userId) {
                console.log('å˜—è©¦å¾ query parameters ç²å–...');
                const urlParams = new URLSearchParams(window.location.search);
                bookingId = bookingId || urlParams.get('bookingId');
                userId = userId || urlParams.get('userId');
                console.log('å¾ query parameters è§£æåƒæ•¸:', { bookingId, userId });
            }
            
            // æ–¹æ³•3: å˜—è©¦å¾ LIFF ç²å–åƒæ•¸ï¼ˆå¦‚æœåœ¨ LINE ç’°å¢ƒä¸­ï¼‰
            if ((!bookingId || !userId) && typeof liff !== 'undefined') {
                try {
                    const liffData = liff.getDecodedIDToken();
                    console.log('LIFF è§£ç¢¼è³‡æ–™:', liffData);
                    // é€™è£¡å¯ä»¥æ ¹æ“šæ‚¨çš„éœ€æ±‚å¾ LIFF å–å¾— userId
                    if (liffData && liffData.sub) {
                        userId = userId || liffData.sub;
                        console.log('å¾ LIFF å–å¾— userId:', userId);
                    }
                } catch (error) {
                    console.log('ç„¡æ³•å¾ LIFF å–å¾—åƒæ•¸:', error);
                }
            }

            console.log('æœ€çµ‚è§£æçµæœ:', { bookingId, userId });
            updateDebugInfo('paramsDebug', `bookingId: ${bookingId || 'ç„¡'}, userId: ${userId || 'ç„¡'}`);

            if (!bookingId || !userId) {
                const errorMsg = 'ç¼ºå°‘å¿…è¦çš„åƒæ•¸ - bookingId: ' + (bookingId || 'ç„¡') + ', userId: ' + (userId || 'ç„¡');
                showError(errorMsg);
                document.getElementById('loading').style.display = 'none';
                
                // é¡¯ç¤ºé™¤éŒ¯è³‡è¨Š
                const debugInfo = document.querySelector('.debug-info');
                if (debugInfo) {
                    debugInfo.style.display = 'block';
                }
                
                return false;
            }

            return true;
        }

        async function initializeLiff() {
            try {
                updateDebugInfo('liffStatus', 'åˆå§‹åŒ–ä¸­...');

                // æœ¬åœ°æ¸¬è©¦æ¨¡å¼
                if (window.location.hostname === '127.0.0.1' || window.location.hostname === 'localhost') {
                    updateDebugInfo('liffStatus', 'æœ¬åœ°æ¸¬è©¦æ¨¡å¼');
                    return;
                }

                // å¯¦éš›çš„ LIFF åˆå§‹åŒ–
                if (typeof liff !== 'undefined') {
                    await liff.init({ liffId: '2007724265-4z7Jd6bV' });
                    if (liff.isLoggedIn()) {
                        updateDebugInfo('liffStatus', 'å·²ç™»å…¥');
                        
                        // ğŸ”§ å˜—è©¦å¾ LIFF ç²å– userIdï¼ˆå¦‚æœå‰é¢æ²’æœ‰å–å¾—ï¼‰
                        if (!userId) {
                            try {
                                const profile = await liff.getProfile();
                                userId = profile.userId;
                                console.log('å¾ LIFF Profile å–å¾— userId:', userId);
                                updateDebugInfo('paramsDebug', `bookingId: ${bookingId || 'ç„¡'}, userId: ${userId || 'ç„¡'}`);
                            } catch (error) {
                                console.log('ç„¡æ³•å¾ LIFF Profile å–å¾— userId:', error);
                            }
                        }
                    } else {
                        updateDebugInfo('liffStatus', 'æœªç™»å…¥');
                    }
                } else {
                    updateDebugInfo('liffStatus', 'LIFF SDK æœªè¼‰å…¥');
                }
            } catch (error) {
                logError(error);
                updateDebugInfo('liffStatus', 'å¤±æ•—: ' + error.message);
            }
        }

        async function callGAS(action, data) {
            try {
                const payload = { action, ...data };
                console.log('ç™¼é€åˆ° GAS çš„è³‡æ–™:', payload);
                updateDebugInfo('requestStatus', 'ç™¼é€ä¸­...');

                const response = await fetch(GAS_WEB_APP_URL, {
                    method: 'POST',
                    body: JSON.stringify(payload),
                    redirect: 'follow'
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();
                updateDebugInfo('requestStatus', 'å®Œæˆ');
                
                console.log('GAS å›æ‡‰:', result);
                
                return result;

            } catch (error) {
                console.error('GAS API èª¿ç”¨å¤±æ•—:', error);
                updateDebugInfo('requestStatus', 'å¤±æ•—: ' + error.message);
                logError(error);
                throw error;
            }
        }

        async function fetchBookingData() {
            try {
                console.log('é–‹å§‹æŸ¥è©¢é ç´„è³‡æ–™...', { bookingId, userId });
                
                const result = await callGAS('getBooking', {
                    bookingId: bookingId,
                    userId: userId
                });

                console.log('æŸ¥è©¢çµæœ:', result);

                if (result.success) {
                    bookingData = result.data;
                    displayBookingData();
                } else {
                    showError(result.message || 'æ‰¾ä¸åˆ°é ç´„è³‡æ–™');
                }

            } catch (error) {
                console.error('æŸ¥è©¢é ç´„å¤±æ•—:', error);
                showError('æŸ¥è©¢å¤±æ•—ï¼š' + error.message);
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        function displayBookingData() {
            console.log('é¡¯ç¤ºé ç´„è³‡æ–™:', bookingData);
            
            document.getElementById('displayBookingId').textContent = bookingData.bookingId || 'ç„¡';
            document.getElementById('customerName').textContent = bookingData.name || 'ç„¡';
            document.getElementById('customerPhone').textContent = bookingData.phone || 'ç„¡';
            document.getElementById('carPlate').textContent = bookingData.plate || 'ç„¡';
            document.getElementById('appointmentDate').textContent = formatDate(bookingData.date);
            document.getElementById('appointmentTime').textContent = formatTime(bookingData.time) || 'ç„¡';
            document.getElementById('serviceType').textContent = bookingData.serviceType || 'ç„¡';
            document.getElementById('appointmentNote').textContent = bookingData.note || 'ç„¡';
            
            const createdTime = bookingData.timestamp || bookingData.createdAt || bookingData.createdTime;
            if (createdTime) {
                document.getElementById('createdTime').textContent = formatDateTime(createdTime);
            } else {
                document.getElementById('createdTime').textContent = 'ç„¡è³‡æ–™';
            }

            const statusElement = document.getElementById('bookingStatus');
            const cancelBtn = document.getElementById('cancelBtn');

            if (bookingData.status === 'cancelled' || bookingData.status === 'å·²å–æ¶ˆ') {
                statusElement.textContent = 'å·²å–æ¶ˆ';
                statusElement.className = 'booking-status status-cancelled';
                cancelBtn.style.display = 'none';
            } else {
                statusElement.textContent = 'é ç´„ä¸­';
                statusElement.className = 'booking-status status-active';
                cancelBtn.style.display = 'inline-block';
            }

            document.getElementById('bookingDetails').style.display = 'block';
        }

        function formatTime(timeString) {
            if (!timeString) return 'ç„¡';
            
            try {
                if (timeString.match(/^\d{1,2}:\d{2}$/)) {
                    return timeString;
                }
                
                if (timeString.includes('T') && timeString.includes('Z')) {
                    const date = new Date(timeString);
                    
                    if (isNaN(date.getTime())) {
                        return 'æ™‚é–“æ ¼å¼éŒ¯èª¤';
                    }
                    
                    if (date.getFullYear() < 1900) {
                        const timeOnly = date.toISOString().split('T')[1];
                        const timePart = timeOnly.split(':');
                        const hours = parseInt(timePart[0]);
                        const minutes = parseInt(timePart[1]);
                        
                        let adjustedHours = hours + 8;
                        if (adjustedHours >= 24) adjustedHours -= 24;
                        if (adjustedHours < 0) adjustedHours += 24;
                        
                        return `${String(adjustedHours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
                    }
                    
                    const taiwanTime = new Date(date.getTime() + (8 * 60 * 60 * 1000));
                    return `${String(taiwanTime.getUTCHours()).padStart(2, '0')}:${String(taiwanTime.getUTCMinutes()).padStart(2, '0')}`;
                }
                
                if (!isNaN(timeString)) {
                    const num = parseFloat(timeString);
                    
                    if (num >= 0 && num < 1) {
                        const totalMinutes = Math.round(num * 24 * 60);
                        const hours = Math.floor(totalMinutes / 60);
                        const minutes = totalMinutes % 60;
                        return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
                    }
                }
                
                console.log('æœªçŸ¥æ™‚é–“æ ¼å¼:', timeString);
                return timeString;
                
            } catch (error) {
                console.error('æ™‚é–“æ ¼å¼åŒ–éŒ¯èª¤:', error, 'åŸå§‹å€¼:', timeString);
                return 'æ™‚é–“æ ¼å¼éŒ¯èª¤';
            }
        }

        function formatDate(dateString) {
            if (!dateString) return 'ç„¡';
            
            try {
                let date;
                if (dateString.includes('/')) {
                    const parts = dateString.split('/');
                    date = new Date(parts[0], parts[1] - 1, parts[2]);
                } else if (dateString.includes('-')) {
                    date = new Date(dateString);
                } else {
                    return dateString;
                }
                
                if (isNaN(date.getTime())) {
                    return dateString;
                }
                
                const weekDays = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
                return `${date.getFullYear()}/${String(date.getMonth()+1).padStart(2, '0')}/${String(date.getDate()).padStart(2, '0')} (${weekDays[date.getDay()]})`;
            } catch (error) {
                console.error('æ—¥æœŸæ ¼å¼åŒ–éŒ¯èª¤:', error);
                return dateString;
            }
        }

        function formatDateTime(timestamp) {
            if (!timestamp) return 'ç„¡';
            
            try {
                const date = new Date(timestamp);
                if (isNaN(date.getTime())) {
                    return timestamp;
                }
                return `${date.getFullYear()}/${String(date.getMonth()+1).padStart(2,'0')}/${String(date.getDate()).padStart(2,'0')} ${String(date.getHours()).padStart(2,'0')}:${String(date.getMinutes()).padStart(2,'0')}`;
            } catch (error) {
                console.error('æ™‚é–“æ ¼å¼åŒ–éŒ¯èª¤:', error);
                return timestamp;
            }
        }

        function showError(message) {
            document.getElementById('errorText').textContent = message;
            document.getElementById('errorMessage').style.display = 'block';
            document.getElementById('loading').style.display = 'none';
        }

        async function cancelBooking() {
            const cancelBtn = document.getElementById('confirmCancelBtn');
            cancelBtn.disabled = true;
            cancelBtn.textContent = 'è™•ç†ä¸­...';

            try {
                const result = await callGAS('cancelBooking', {
                    bookingId: bookingId,
                    userId: userId
                });

                if (result.success) {
                    document.getElementById('cancelModal').style.display = 'none';
                    document.getElementById('successMessage').style.display = 'block';
                    document.getElementById('bookingDetails').style.display = 'none';
                } else {
                    alert('å–æ¶ˆå¤±æ•—ï¼š' + (result.message || 'è«‹ç¨å¾Œå†è©¦'));
                }

            } catch (error) {
                console.error('å–æ¶ˆé ç´„å¤±æ•—:', error);
                alert('å–æ¶ˆå¤±æ•—ï¼š' + error.message);
            } finally {
                cancelBtn.disabled = false;
                cancelBtn.textContent = 'ç¢ºèªå–æ¶ˆ';
            }
        }

        async function testApiConnection() {
            try {
                console.log('æ¸¬è©¦ API é€£æ¥...');
                updateDebugInfo('requestStatus', 'æ¸¬è©¦é€£æ¥...');
                
                const result = await callGAS('testConnection', {});
                console.log('API é€£æ¥æ¸¬è©¦çµæœ:', result);
                
                if (result.success) {
                    updateDebugInfo('requestStatus', 'API é€£æ¥æ­£å¸¸');
                } else {
                    updateDebugInfo('requestStatus', 'API é€£æ¥å¤±æ•—');
                }
            } catch (error) {
                console.error('API é€£æ¥æ¸¬è©¦å¤±æ•—:', error);
                updateDebugInfo('requestStatus', 'API é€£æ¥æ¸¬è©¦å¤±æ•—');
            }
        }

        document.addEventListener('DOMContentLoaded', function () {
            console.log('é é¢è¼‰å…¥å®Œæˆï¼Œé–‹å§‹åˆå§‹åŒ–...');
            
            testApiConnection();
            
            // ğŸ”§ å…ˆåˆå§‹åŒ– LIFFï¼Œå†è§£æåƒæ•¸
            initializeLiff().then(() => {
                console.log('LIFF åˆå§‹åŒ–å®Œæˆ');
                
                // è§£æ URL åƒæ•¸
                if (getUrlParameters()) {
                    console.log('åƒæ•¸è§£ææˆåŠŸï¼Œé–‹å§‹æŸ¥è©¢é ç´„è³‡æ–™...');
                    fetchBookingData();
                } else {
                    console.log('åƒæ•¸è§£æå¤±æ•—');
                }
            }).catch(error => {
                console.error('LIFF åˆå§‹åŒ–å¤±æ•—:', error);
                // å³ä½¿ LIFF åˆå§‹åŒ–å¤±æ•—ï¼Œä»ç„¶å˜—è©¦è§£æåƒæ•¸
                if (getUrlParameters()) {
                    fetchBookingData();
                }
            });

            // äº‹ä»¶ç›£è½å™¨
            document.getElementById('cancelBtn').addEventListener('click', () => {
                document.getElementById('cancelModal').style.display = 'block';
            });

            document.getElementById('confirmCancelBtn').addEventListener('click', cancelBooking);
            
            document.getElementById('cancelCancelBtn').addEventListener('click', () => {
                document.getElementById('cancelModal').style.display = 'none';
            });

            document.getElementById('cancelModal').addEventListener('click', function(e) {
                if (e.target === this) this.style.display = 'none';
            });

            // ğŸ”§ ç§»é™¤ä¸å­˜åœ¨çš„ closeBtn äº‹ä»¶ç›£è½å™¨
            const closeBtn = document.getElementById('closeBtn');
            if (closeBtn) {
                closeBtn.addEventListener('click', () => {
                    if (typeof liff !== 'undefined' && liff.isInClient()) {
                        liff.closeWindow();
                    } else {
                        window.history.back();
                    }
                });
            }
        });
    </script>
</body>
</html>