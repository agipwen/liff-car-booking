
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>預約系統管理</title>
    <link rel="stylesheet" href="crud.css">
    <script src="https://kit.fontawesome.com/ca83b2e10a.js" crossorigin="anonymous"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fa-solid fa-car"></i>&nbsp;管理預約</h1>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('create')">新增預約</button>
            <button class="tab" onclick="switchTab('search')">搜尋預約</button>
        </div>

        <!-- 新增預約 -->
        <div id="create" class="tab-content active">
            <form id="createForm">
                <div class="form-row">
                    <div class="form-group">
                        <label for="name">姓名 *</label>
                        <input type="text" id="name" name="name" required>
                    </div>
                    <div class="form-group">
                        <label for="phone">電話</label>
                        <input type="tel" id="phone" name="phone">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="date">預約日期 *</label>
                        <input type="date" id="date" name="date" required>
                    </div>
                    <div class="form-group">
                        <label for="time">預約時段 *</label>
                        <select id="time" name="time" required>
                            <option value="">請選擇時段</option>
                            <option value="08:00">08:00</option>
                            <option value="08:30">08:30</option>
                            <option value="09:00">09:00</option>
                            <option value="09:30">09:30</option>
                            <option value="10:00">10:00</option>
                            <option value="10:30">10:30</option>
                            <option value="11:00">11:00</option>
                            <option disabled>───────</option>
                            <option value="13:30">13:30</option>
                            <option value="14:00">14:00</option>
                            <option value="14:30">14:30</option>
                            <option value="15:00">15:00</option>
                            <option value="15:30">15:30</option>
                            <option value="16:00">16:00</option>
                            <option value="16:30">16:30</option>
                            </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="carPlate">車牌</label>
                        <input type="text" id="carPlate" name="carPlate" placeholder="例如：ABC-1234">
                    </div>
                    <div class="form-group">
                        <label for="service">服務項目</label>
                        <select id="service" name="service">
                            <option value="">請選擇服務項目</option>
                            <option value="保養">保養</option>
                            <option value="維修">維修</option>
                            <option value="其他">其他</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label for="note">備註</label>
                    <textarea id="note" name="note" style="margin-top:5px" placeholder="請輸入其他需要說明的事項..."></textarea>
                </div>

                <div style="display: flex; justify-content: center;">
                    <button type="submit" class="btn btn-primary">建立預約</button>
                </div>

            </form>

            <div class="loading" id="createLoading" style="display: none;">
                <div class="spinner"></div>
                <p>建立中...</p>
            </div>
        </div>

        <!-- 搜尋預約 -->
        <div id="search" class="tab-content">
            <div class="search-bar">
                <div class="form-group">
                    <label for="searchType">搜尋類型</label>
                    <select id="searchType">
                        <option value="bookingNumber">預約編號</option>
                        <option value="name">姓名</option>
                        <option value="phone">電話</option>
                        <option value="carPlate">車牌</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="searchTerm">搜尋關鍵字</label>
                    <input type="text" id="searchTerm" placeholder="請輸入搜尋關鍵字...">
                </div>
                <button type="button" class="btn btn-primary" onclick="searchBookings()">搜尋</button>
            </div>

            <div class="loading" id="searchLoading">
                <div class="spinner"></div>
                <p>搜尋中...</p>
            </div>

            <div id="searchResults" class="results"></div>
        </div>
    </div>

    <script>
// Google Apps Script 部署網址
const GAS_URL = 'https://script.google.com/macros/s/AKfycbwh9ZRl5Ao5PJk8sb0vq8UPJpgwrvU3K5Kh_4OcZwfoXtA8kI5Sdz0sBDKj8GLOf9nw/exec';

// 切換分頁
function switchTab(tabName) {
    // 隱藏所有分頁內容
    document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
    });
    
    // 移除所有分頁按鈕的active狀態
    document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // 顯示選中的分頁內容
    document.getElementById(tabName).classList.add('active');
    
    // 設置對應按鈕為active
    event.target.classList.add('active');
}

// 顯示訊息
function showMessage(message, type = 'success') {
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${type}`;
    messageDiv.textContent = message;
    
    // 根據當前分頁顯示訊息
    const activeTab = document.querySelector('.tab-content.active');
    activeTab.insertBefore(messageDiv, activeTab.firstChild);
    
    // 3秒後自動消失
    setTimeout(() => {
        messageDiv.remove();
    }, 3000);
}

// 使用 JSONP 方式調用 Google Apps Script API
function callGAS(action, data = {}) {
    return new Promise((resolve, reject) => {
        // 創建唯一的回調函數名
        const callbackName = 'gasCallback_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        
        // 將回調函數附加到 window 對象
        window[callbackName] = function(response) {
            // 清理
            document.head.removeChild(script);
            delete window[callbackName];
            
            if (response.success !== undefined) {
                resolve(response);
            } else {
                reject(new Error('無效的回應格式'));
            }
        };
        
        // 創建 script 標籤
        const script = document.createElement('script');
        
        // 構建 URL 參數
        const params = new URLSearchParams({
            action: action,
            data: JSON.stringify(data),
            callback: callbackName
        });
        
        script.src = `${GAS_URL}?${params.toString()}`;
        
        // 錯誤處理
        script.onerror = function() {
            document.head.removeChild(script);
            delete window[callbackName];
            reject(new Error('網路連接失敗'));
        };
        
        // 添加到頁面
        document.head.appendChild(script);
        
        // 設置超時
        setTimeout(() => {
            if (window[callbackName]) {
                document.head.removeChild(script);
                delete window[callbackName];
                reject(new Error('請求超時'));
            }
        }, 30000); // 30秒超時
    });
}

// 新增預約
document.getElementById('createForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    const form = document.getElementById('createForm');
    const loading = document.getElementById('createLoading');
    
    // 隱藏表單並顯示載入動畫
    form.style.display = 'none';
    loading.style.display = 'block';

    const formData = new FormData(e.target);
    const bookingData = {
        name: formData.get('name') || '',
        phone: formData.get('phone') || '',
        date: String(formData.get('date') || '').slice(0, 10),
        time: String(formData.get('time') || '').slice(0, 5),
        carPlate: formData.get('carPlate') || '',
        service: formData.get('service') || '',
        note: formData.get('note') || ''
    };

    try {
        const result = await callGAS('createBooking', bookingData);

        if (result.success) {
            showMessage('預約新增成功！預約編號：' + result.bookingNumber, 'success');
            e.target.reset();
        } else {
            showMessage(result.message, 'error');
        }
    } catch (error) {
        showMessage('預約新增失敗：' + error.message, 'error');
    } finally {
        // 恢復表單顯示並隱藏載入動畫
        form.style.display = 'block';
        loading.style.display = 'none';
    }
});


// 搜尋預約
async function searchBookings() {
    const searchTerm = document.getElementById('searchTerm').value;
    const searchType = document.getElementById('searchType').value;
    
    if (!searchTerm.trim()) {
        showMessage('請輸入搜尋關鍵字', 'error');
        return;
    }
    
    const loading = document.getElementById('searchLoading');
    const results = document.getElementById('searchResults');
    
    loading.style.display = 'block';
    results.innerHTML = '';
    
    try {
        const result = await callGAS('searchBookings', {
            searchTerm: searchTerm,
            searchType: searchType
        });
        
        loading.style.display = 'none';
        
        if (result.success) {
            displaySearchResults(result.results);
        } else {
            showMessage(result.message, 'error');
        }
    } catch (error) {
        loading.style.display = 'none';
        showMessage('搜尋失敗：' + error.message, 'error');
    }
}

// 顯示搜尋結果（含修改功能）
function displaySearchResults(results) {
    const resultsDiv = document.getElementById('searchResults');
    
    if (results.length === 0) {
        resultsDiv.innerHTML = '<p style="text-align: center; color: #666; font-size: 1.1rem;">沒有找到符合條件的預約</p>';
        return;
    }
    
    resultsDiv.innerHTML = results.map(result => `
        <div class="result-item">
            <div class="result-header">
                <div class="booking-number">${result.data.預約編號}</div>
                <div class="status ${result.data.狀態 === '已預約' ? 'confirmed' : 'cancelled'}">
                    ${result.data.狀態}
                </div>
            </div>
            <div class="result-details">
                <div class="detail-item">
                    <div class="detail-label">姓名</div>
                    <div class="detail-value">${result.data.姓名}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">電話</div>
                    <div class="detail-value">${result.data.電話 || '-'}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">車牌</div>
                    <div class="detail-value">${result.data.車牌 || '-'}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">預約日期</div>
                    <div class="detail-value">${String(result.data.預約日期).slice(0, 10)}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">預約時段</div>
                    <div class="detail-value">${formatTime(result.data.預約時段)}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">服務項目</div>
                    <div class="detail-value">${result.data.服務項目 || '-'}</div>
                </div>
            </div>
            ${result.data.備註 ? `
                <div class="detail-item" style="margin-top: 15px;">
                    <div class="detail-label">備註</div>
                    <div class="detail-value">${result.data.備註}</div>
                </div>
            ` : ''}
            <div class="result-actions" id="actions-${result.data.預約編號}">
                <button class="btn btn-secondary" onclick="showUpdateForm('${result.data.預約編號}')">修改</button>
                <button class="btn btn-danger" onclick="cancelBooking('${result.data.預約編號}')">取消預約</button>
                <button class="btn btn-danger" onclick="deleteBooking('${result.data.預約編號}')">刪除</button>
                <div class="loading-inline" id="loading-${result.data.預約編號}" style="display:none;">
                    <div class="spinner" style="width:16px; height:16px; border-width: 2px;"></div>
                    <span>載入中...</span>
                </div>
            </div>

            <div id="updateForm-${result.data.預約編號}" class="update-form" style="display: none;">
                <h3>修改預約資訊</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label>姓名</label>
                        <input type="text" value="${result.data.姓名}" id="updateName-${result.data.預約編號}">
                    </div>
                    <div class="form-group">
                        <label>電話</label>
                        <input type="tel" value="${result.data.電話}" id="updatePhone-${result.data.預約編號}">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>預約日期</label>
                        <input type="date" value="${result.data.預約日期}" id="updateDate-${result.data.預約編號}">
                    </div>
                    <div class="form-group">
                        <label>預約時段</label>
                        <select id="updateTime-${result.data.預約編號}">
                            <option value="">請選擇時段</option>
                            <option value="08:00" ${result.data.預約時段 === '08:00' ? 'selected' : ''}>08:00</option>
                            <option value="08:30" ${result.data.預約時段 === '08:30' ? 'selected' : ''}>08:30</option>
                            <option value="09:00" ${result.data.預約時段 === '09:00' ? 'selected' : ''}>09:00</option>
                            <option value="09:30" ${result.data.預約時段 === '09:30' ? 'selected' : ''}>09:30</option>
                            <option value="10:00" ${result.data.預約時段 === '10:00' ? 'selected' : ''}>10:00</option>
                            <option value="10:30" ${result.data.預約時段 === '10:30' ? 'selected' : ''}>10:30</option>
                            <option value="11:00" ${result.data.預約時段 === '11:00' ? 'selected' : ''}>11:00</option>
                            <option value="13:30" ${result.data.預約時段 === '13:30' ? 'selected' : ''}>13:30</option>
                            <option value="14:00" ${result.data.預約時段 === '14:00' ? 'selected' : ''}>14:00</option>
                            <option value="14:30" ${result.data.預約時段 === '14:30' ? 'selected' : ''}>14:30</option>
                            <option value="15:00" ${result.data.預約時段 === '15:00' ? 'selected' : ''}>15:00</option>
                            <option value="15:30" ${result.data.預約時段 === '15:30' ? 'selected' : ''}>15:30</option>
                            <option value="16:00" ${result.data.預約時段 === '16:00' ? 'selected' : ''}>16:00</option>
                            <option value="16:30" ${result.data.預約時段 === '16:30' ? 'selected' : ''}>16:30</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>車牌</label>
                        <input type="text" value="${result.data.車牌}" id="updateCarPlate-${result.data.預約編號}">
                    </div>
                    <div class="form-group">
                        <label>服務項目</label>
                        <select id="updateService-${result.data.預約編號}">
                            <option value="">請選擇服務項目</option>
                            <option value="保養" ${result.data.服務項目 === '保養' ? 'selected' : ''}>保養</option>
                            <option value="維修" ${result.data.服務項目 === '維修' ? 'selected' : ''}>維修</option>
                            <option value="其他" ${result.data.服務項目 === '其他' ? 'selected' : ''}>其他</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>備註</label>
                    <textarea id="updateNote-${result.data.預約編號}">${result.data.備註 || ''}</textarea>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button class="btn btn-primary" onclick="updateBooking('${result.data.預約編號}')">確認修改</button>
                    <button class="btn btn-secondary" onclick="hideUpdateForm('${result.data.預約編號}')">取消</button>
                </div>
            </div>
        </div>
    `).join('');
}

function setLoading(bookingNumber, isLoading) {
    const loadingDiv = document.getElementById(`loading-${bookingNumber}`);
    const actionsDiv = document.getElementById(`actions-${bookingNumber}`);

    if (loadingDiv && actionsDiv) {
        if (isLoading) {
            loadingDiv.style.display = 'inline-flex';
            // 按鈕都禁用避免重複點擊
            actionsDiv.querySelectorAll('button').forEach(btn => btn.disabled = true);
        } else {
            loadingDiv.style.display = 'none';
            actionsDiv.querySelectorAll('button').forEach(btn => btn.disabled = false);
        }
    }
}


function formatTime(value) {
    if (!value) return '-';

    // 若為 ISO 格式時間
    const date = new Date(value);
    if (isNaN(date)) return value;

    const hours = String(date.getHours()).padStart(2, '0');
    const minutes = String(date.getMinutes()).padStart(2, '0');
    return `${hours}:${minutes}`;
}


// 管理預約搜尋
async function searchForManage() {
    const searchTerm = document.getElementById('manageSearchTerm').value;
    
    if (!searchTerm.trim()) {
        showMessage('請輸入預約編號', 'error');
        return;
    }
    
    const loading = document.getElementById('manageLoading');
    const results = document.getElementById('manageResults');
    
    loading.style.display = 'block';
    results.innerHTML = '';
    
    try {
        const result = await callGAS('searchBookings', {
            searchTerm: searchTerm,
            searchType: 'bookingNumber'
        });
        
        loading.style.display = 'none';
        
        if (result.success) {
            displayManageResults(result.results);
        } else {
            showMessage(result.message, 'error');
        }
    } catch (error) {
        loading.style.display = 'none';
        showMessage('查詢失敗：' + error.message, 'error');
    }
}

// 顯示管理結果
function displayManageResults(results) {
    const resultsDiv = document.getElementById('manageResults');
    
    if (results.length === 0) {
        resultsDiv.innerHTML = '<p style="text-align: center; color: #666; font-size: 1.1rem;">沒有找到該預約編號</p>';
        return;
    }
    
    resultsDiv.innerHTML = results.map(result => `
        <div class="result-item">
            <div class="result-header">
                <div class="booking-number">${result.data.預約編號}</div>
                <div class="status ${result.data.狀態 === '已預約' ? 'confirmed' : 'cancelled'}">
                    ${result.data.狀態}
                </div>
            </div>
            <div class="result-details">
                <div class="detail-item">
                    <div class="detail-label">姓名</div>
                    <div class="detail-value">${result.data.姓名}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">電話</div>
                    <div class="detail-value">${result.data.電話 || '-'}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">車牌</div>
                    <div class="detail-value">${result.data.車牌 || '-'}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">預約日期</div>
                    <div class="detail-value">${result.data.預約日期}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">預約時段</div>
                    <div class="detail-value">${result.data.預約時段}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">服務項目</div>
                    <div class="detail-value">${result.data.服務項目 || '-'}</div>
                </div>
            </div>
            ${result.data.備註 ? `
                <div class="detail-item" style="margin-top: 15px;">
                    <div class="detail-label">備註</div>
                    <div class="detail-value">${result.data.備註}</div>
                </div>
            ` : ''}
            <div class="result-actions">
                <button class="btn btn-secondary" onclick="showUpdateForm('${result.data.預約編號}')">修改</button>
                <button class="btn btn-danger" onclick="cancelBooking('${result.data.預約編號}')">取消預約</button>
                <button class="btn btn-danger" onclick="deleteBooking('${result.data.預約編號}')">刪除</button>
            </div>
            <div id="updateForm-${result.data.預約編號}" class="update-form" style="display: none;">
                <h3>修改預約資訊</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label>姓名</label>
                        <input type="text" value="${result.data.姓名}" id="updateName-${result.data.預約編號}">
                    </div>
                    <div class="form-group">
                        <label>電話</label>
                        <input type="tel" value="${result.data.電話}" id="updatePhone-${result.data.預約編號}">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>預約日期</label>
                        <input type="date" value="${result.data.預約日期}" id="updateDate-${result.data.預約編號}">
                    </div>
                    <div class="form-group">
                        <label>預約時段</label>
                        <select id="updateTime-${result.data.預約編號}">
                            <option value="">請選擇時段</option>
                            <option value="08:00" ${result.data.預約時段 === '08:00' ? 'selected' : ''}>08:00</option>
                            <option value="08:30" ${result.data.預約時段 === '08:30' ? 'selected' : ''}>08:30</option>
                            <option value="09:00" ${result.data.預約時段 === '09:00' ? 'selected' : ''}>09:00</option>
                            <option value="09:30" ${result.data.預約時段 === '09:30' ? 'selected' : ''}>09:30</option>
                            <option value="10:00" ${result.data.預約時段 === '10:00' ? 'selected' : ''}>10:00</option>
                            <option value="10:30" ${result.data.預約時段 === '10:30' ? 'selected' : ''}>10:30</option>
                            <option value="11:00" ${result.data.預約時段 === '11:00' ? 'selected' : ''}>11:00</option>
                            <option value="13:30" ${result.data.預約時段 === '13:30' ? 'selected' : ''}>13:30</option>
                            <option value="14:00" ${result.data.預約時段 === '14:00' ? 'selected' : ''}>14:00</option>
                            <option value="14:30" ${result.data.預約時段 === '14:30' ? 'selected' : ''}>14:30</option>
                            <option value="15:00" ${result.data.預約時段 === '15:00' ? 'selected' : ''}>15:00</option>
                            <option value="15:30" ${result.data.預約時段 === '15:30' ? 'selected' : ''}>15:30</option>
                            <option value="16:00" ${result.data.預約時段 === '16:00' ? 'selected' : ''}>16:00</option>
                            <option value="16:30" ${result.data.預約時段 === '16:30' ? 'selected' : ''}>16:30</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>車牌</label>
                        <input type="text" value="${result.data.車牌}" id="updateCarPlate-${result.data.預約編號}">
                    </div>
                    <div class="form-group">
                        <label>服務項目</label>
                        <select id="updateService-${result.data.預約編號}">
                            <option value="">請選擇服務項目</option>
                            <option value="保養" ${result.data.服務項目 === '保養' ? 'selected' : ''}>保養</option>
                            <option value="維修" ${result.data.服務項目 === '維修' ? 'selected' : ''}>維修</option>
                            <option value="其他" ${result.data.服務項目 === '其他' ? 'selected' : ''}>其他</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>備註</label>
                    <textarea id="updateNote-${result.data.預約編號}">${result.data.備註 || ''}</textarea>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button class="btn btn-primary" onclick="updateBooking('${result.data.預約編號}')">確認修改</button>
                    <button class="btn btn-secondary" onclick="hideUpdateForm('${result.data.預約編號}')">取消</button>
                </div>
            </div>
        </div>
    `).join('');
}

// 顯示修改表單
function showUpdateForm(bookingNumber) {
    const form = document.getElementById(`updateForm-${bookingNumber}`);
    form.style.display = form.style.display === 'none' ? 'block' : 'none';
    
    // 設置日期最小值為今天
    const today = new Date().toISOString().split('T')[0];
    const dateInput = document.getElementById(`updateDate-${bookingNumber}`);
    if (dateInput) {
        dateInput.min = today;
    }
}

// 隱藏修改表單
function hideUpdateForm(bookingNumber) {
    document.getElementById(`updateForm-${bookingNumber}`).style.display = 'none';
}

// 更新預約
async function updateBooking(bookingNumber) {
    const updateData = {
        name: document.getElementById(`updateName-${bookingNumber}`).value,
        phone: document.getElementById(`updatePhone-${bookingNumber}`).value,
        date: document.getElementById(`updateDate-${bookingNumber}`).value,
        time: document.getElementById(`updateTime-${bookingNumber}`).value,
        carPlate: document.getElementById(`updateCarPlate-${bookingNumber}`).value,
        service: document.getElementById(`updateService-${bookingNumber}`).value,
        note: document.getElementById(`updateNote-${bookingNumber}`).value
    };
    
    // 簡單驗證
    if (!updateData.name.trim()) {
        showMessage('請輸入姓名', 'error');
        return;
    }
    
    if (!updateData.date) {
        showMessage('請選擇預約日期', 'error');
        return;
    }
    
    if (!updateData.time) {
        showMessage('請選擇預約時段', 'error');
        return;
    }
    
    try {
        const result = await callGAS('updateBooking', {
            bookingNumber: bookingNumber,
            updateData: updateData
        });
        
        if (result.success) {
            showMessage(`預約 ${bookingNumber} 修改成功！`, 'success');
            hideUpdateForm(bookingNumber);
            
            // 重新搜尋以更新顯示
            if (document.querySelector('.tab-content#search.active')) {
                searchBookings();
            } else {
                searchForManage();
            }
        } else {
            showMessage(result.message, 'error');
        }
    } catch (error) {
        showMessage('修改失敗：' + error.message, 'error');
    }
}

// 取消預約
async function cancelBooking(bookingNumber) {
    if (confirm(`確定要取消預約 ${bookingNumber} 嗎？`)) {
        try {
            const result = await callGAS('cancelBooking', {
                bookingNumber: bookingNumber
            });
            
            if (result.success) {
                showMessage(`預約 ${bookingNumber} 已取消`, 'success');
                
                // 重新搜尋以更新顯示
                if (document.querySelector('.tab-content#search.active')) {
                    searchBookings();
                } else {
                    searchForManage();
                }
            } else {
                showMessage(result.message, 'error');
            }
        } catch (error) {
            showMessage('取消失敗：' + error.message, 'error');
        }
    }
}

// 刪除預約
async function deleteBooking(bookingNumber) {
    if (confirm(`確定要刪除預約 ${bookingNumber} 嗎？此操作無法復原！`)) {
        try {
            const result = await callGAS('deleteBooking', {
                bookingNumber: bookingNumber
            });
            
            if (result.success) {
                showMessage(`預約 ${bookingNumber} 已刪除`, 'success');
                
                // 重新搜尋以更新顯示
                if (document.querySelector('.tab-content#search.active')) {
                    searchBookings();
                } else {
                    searchForManage();
                }
            } else {
                showMessage(result.message, 'error');
            }
        } catch (error) {
            showMessage('刪除失敗：' + error.message, 'error');
        }
    }
}

// 頁面載入後的初始化
document.addEventListener('DOMContentLoaded', function() {
    // 設置今天作為預約日期的最小值
    const today = new Date().toISOString().split('T')[0];
    const dateInput = document.getElementById('date');
    if (dateInput) {
        dateInput.min = today;
    }
    
    // 搜尋框按Enter鍵觸發搜尋
    const searchTermInput = document.getElementById('searchTerm');
    if (searchTermInput) {
        searchTermInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchBookings();
            }
        });
    }

    const manageSearchTermInput = document.getElementById('manageSearchTerm');
    if (manageSearchTermInput) {
        manageSearchTermInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchForManage();
            }
        });
    }
});
    </script>
</body>
</html>